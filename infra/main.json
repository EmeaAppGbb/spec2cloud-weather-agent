{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "15553386865316687933"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the environment that can be used as part of naming resource convention"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('rg-{0}', parameters('environmentName'))]",
      "minLength": 1,
      "maxLength": 90,
      "metadata": {
        "description": "Name of the resource group to use or create"
      }
    },
    "location": {
      "type": "string",
      "allowedValues": [
        "australiaeast",
        "brazilsouth",
        "canadacentral",
        "canadaeast",
        "eastus",
        "eastus2",
        "francecentral",
        "germanywestcentral",
        "italynorth",
        "japaneast",
        "koreacentral",
        "northcentralus",
        "norwayeast",
        "polandcentral",
        "southafricanorth",
        "southcentralus",
        "southeastasia",
        "southindia",
        "spaincentral",
        "swedencentral",
        "switzerlandnorth",
        "uaenorth",
        "uksouth",
        "westus",
        "westus2",
        "westus3"
      ],
      "minLength": 1,
      "metadata": {
        "description": "Primary location for all resources"
      }
    },
    "aiDeploymentsLocation": {
      "type": "string",
      "metadata": {
        "azd": {
          "type": "location",
          "usageName": [
            "OpenAI.GlobalStandard.gpt-4o-mini,10"
          ]
        }
      }
    },
    "principalId": {
      "type": "string",
      "metadata": {
        "description": "Id of the user or app to assign application roles"
      }
    },
    "principalType": {
      "type": "string",
      "metadata": {
        "description": "Principal type of user or app"
      }
    },
    "aiFoundryResourceName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Name of an existing AI Services account within the resource group. If not provided, a new one will be created."
      }
    },
    "aiFoundryProjectName": {
      "type": "string",
      "defaultValue": "[format('ai-project-{0}', parameters('environmentName'))]",
      "metadata": {
        "description": "Optional. Name of the AI Foundry project. If not provided, a default name will be used."
      }
    },
    "aiProjectDeploymentsJson": {
      "type": "string",
      "defaultValue": "[[]",
      "metadata": {
        "description": "List of model deployments"
      }
    },
    "aiProjectConnectionsJson": {
      "type": "string",
      "defaultValue": "[[]",
      "metadata": {
        "description": "List of connections"
      }
    },
    "aiProjectDependentResourcesJson": {
      "type": "string",
      "defaultValue": "[[]",
      "metadata": {
        "description": "List of resources to create and connect to the AI project"
      }
    },
    "enableHostedAgents": {
      "type": "bool",
      "metadata": {
        "description": "Enable hosted agent deployment"
      }
    },
    "enableMonitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable monitoring for the AI project"
      }
    },
    "enableContainerApps": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Container Apps deployment for frontend, backend, and MCP server"
      }
    },
    "frontendImageName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container image name for frontend service"
      }
    },
    "backendImageName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container image name for backend service"
      }
    },
    "mcpServerImageName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container image name for MCP server service"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "aiFoundryAccounts": "aif",
      "analysisServicesServers": "as",
      "apiManagementService": "apim-",
      "appConfigurationStores": "appcs-",
      "appManagedEnvironments": "cae-",
      "appContainerApps": "ca-",
      "authorizationPolicyDefinitions": "policy-",
      "automationAutomationAccounts": "aa-",
      "blueprintBlueprints": "bp-",
      "blueprintBlueprintsArtifacts": "bpa-",
      "cacheRedis": "redis-",
      "cdnProfiles": "cdnp-",
      "cdnProfilesEndpoints": "cdne-",
      "cognitiveServicesAccounts": "cog-",
      "cognitiveServicesFormRecognizer": "cog-fr-",
      "cognitiveServicesTextAnalytics": "cog-ta-",
      "computeAvailabilitySets": "avail-",
      "computeCloudServices": "cld-",
      "computeDiskEncryptionSets": "des",
      "computeDisks": "disk",
      "computeDisksOs": "osdisk",
      "computeGalleries": "gal",
      "computeSnapshots": "snap-",
      "computeVirtualMachines": "vm",
      "computeVirtualMachineScaleSets": "vmss-",
      "containerInstanceContainerGroups": "ci",
      "containerRegistryRegistries": "cr",
      "containerServiceManagedClusters": "aks-",
      "databricksWorkspaces": "dbw-",
      "dataFactoryFactories": "adf-",
      "dataLakeAnalyticsAccounts": "dla",
      "dataLakeStoreAccounts": "dls",
      "dataMigrationServices": "dms-",
      "dBforMySQLServers": "mysql-",
      "dBforPostgreSQLServers": "psql-",
      "devicesIotHubs": "iot-",
      "devicesProvisioningServices": "provs-",
      "devicesProvisioningServicesCertificates": "pcert-",
      "documentDBDatabaseAccounts": "cosmos-",
      "documentDBMongoDatabaseAccounts": "cosmon-",
      "eventGridDomains": "evgd-",
      "eventGridDomainsTopics": "evgt-",
      "eventGridEventSubscriptions": "evgs-",
      "eventHubNamespaces": "evhns-",
      "eventHubNamespacesEventHubs": "evh-",
      "hdInsightClustersHadoop": "hadoop-",
      "hdInsightClustersHbase": "hbase-",
      "hdInsightClustersKafka": "kafka-",
      "hdInsightClustersMl": "mls-",
      "hdInsightClustersSpark": "spark-",
      "hdInsightClustersStorm": "storm-",
      "hybridComputeMachines": "arcs-",
      "insightsActionGroups": "ag-",
      "insightsComponents": "appi-",
      "keyVaultVaults": "kv-",
      "kubernetesConnectedClusters": "arck",
      "kustoClusters": "dec",
      "kustoClustersDatabases": "dedb",
      "logicIntegrationAccounts": "ia-",
      "logicWorkflows": "logic-",
      "machineLearningServicesWorkspaces": "mlw-",
      "managedIdentityUserAssignedIdentities": "id-",
      "managementManagementGroups": "mg-",
      "migrateAssessmentProjects": "migr-",
      "networkApplicationGateways": "agw-",
      "networkApplicationSecurityGroups": "asg-",
      "networkAzureFirewalls": "afw-",
      "networkBastionHosts": "bas-",
      "networkConnections": "con-",
      "networkDnsZones": "dnsz-",
      "networkExpressRouteCircuits": "erc-",
      "networkFirewallPolicies": "afwp-",
      "networkFirewallPoliciesWebApplication": "waf",
      "networkFirewallPoliciesRuleGroups": "wafrg",
      "networkFrontDoors": "fd-",
      "networkFrontdoorWebApplicationFirewallPolicies": "fdfp-",
      "networkLoadBalancersExternal": "lbe-",
      "networkLoadBalancersInternal": "lbi-",
      "networkLoadBalancersInboundNatRules": "rule-",
      "networkLocalNetworkGateways": "lgw-",
      "networkNatGateways": "ng-",
      "networkNetworkInterfaces": "nic-",
      "networkNetworkSecurityGroups": "nsg-",
      "networkNetworkSecurityGroupsSecurityRules": "nsgsr-",
      "networkNetworkWatchers": "nw-",
      "networkPrivateDnsZones": "pdnsz-",
      "networkPrivateLinkServices": "pl-",
      "networkPublicIPAddresses": "pip-",
      "networkPublicIPPrefixes": "ippre-",
      "networkRouteFilters": "rf-",
      "networkRouteTables": "rt-",
      "networkRouteTablesRoutes": "udr-",
      "networkTrafficManagerProfiles": "traf-",
      "networkVirtualNetworkGateways": "vgw-",
      "networkVirtualNetworks": "vnet-",
      "networkVirtualNetworksSubnets": "snet-",
      "networkVirtualNetworksVirtualNetworkPeerings": "peer-",
      "networkVirtualWans": "vwan-",
      "networkVpnGateways": "vpng-",
      "networkVpnGatewaysVpnConnections": "vcn-",
      "networkVpnGatewaysVpnSites": "vst-",
      "notificationHubsNamespaces": "ntfns-",
      "notificationHubsNamespacesNotificationHubs": "ntf-",
      "operationalInsightsWorkspaces": "log-",
      "portalDashboards": "dash-",
      "powerBIDedicatedCapacities": "pbi-",
      "purviewAccounts": "pview-",
      "recoveryServicesVaults": "rsv-",
      "resourcesResourceGroups": "rg-",
      "searchSearchServices": "srch-",
      "serviceBusNamespaces": "sb-",
      "serviceBusNamespacesQueues": "sbq-",
      "serviceBusNamespacesTopics": "sbt-",
      "serviceEndPointPolicies": "se-",
      "serviceFabricClusters": "sf-",
      "signalRServiceSignalR": "sigr",
      "sqlManagedInstances": "sqlmi-",
      "sqlServers": "sql-",
      "sqlServersDataWarehouse": "sqldw-",
      "sqlServersDatabases": "sqldb-",
      "sqlServersDatabasesStretch": "sqlstrdb-",
      "storageStorageAccounts": "st",
      "storageStorageAccountsVm": "stvm",
      "storSimpleManagers": "ssimp",
      "streamAnalyticsCluster": "asa-",
      "synapseWorkspaces": "syn",
      "synapseWorkspacesAnalyticsWorkspaces": "synw",
      "synapseWorkspacesSqlPoolsDedicated": "syndp",
      "synapseWorkspacesSqlPoolsSpark": "synsp",
      "timeSeriesInsightsEnvironments": "tsi-",
      "webServerFarms": "plan-",
      "webSitesAppService": "app-",
      "webSitesAppServiceEnvironment": "ase-",
      "webSitesFunctions": "func-",
      "webStaticSites": "stapp-"
    },
    "aiProjectDeployments": "[json(parameters('aiProjectDeploymentsJson'))]",
    "aiProjectConnections": "[json(parameters('aiProjectConnectionsJson'))]",
    "aiProjectDependentResources": "[json(parameters('aiProjectDependentResourcesJson'))]",
    "tags": {
      "azd-env-name": "[parameters('environmentName')]"
    },
    "hasAcr": "[contains(map(variables('aiProjectDependentResources'), lambda('r', lambdaVariables('r').resource)), 'registry')]",
    "dependentResources": "[if(and(parameters('enableHostedAgents'), not(variables('hasAcr'))), union(variables('aiProjectDependentResources'), createArray(createObject('resource', 'registry', 'connectionName', 'acr-connection'))), variables('aiProjectDependentResources'))]",
    "abbrs": "[variables('$fxv#0')]",
    "resourceToken": "[uniqueString(subscription().id, parameters('resourceGroupName'), parameters('location'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ai-project",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "location": {
            "value": "[parameters('aiDeploymentsLocation')]"
          },
          "aiFoundryProjectName": {
            "value": "[parameters('aiFoundryProjectName')]"
          },
          "principalId": {
            "value": "[parameters('principalId')]"
          },
          "principalType": {
            "value": "[parameters('principalType')]"
          },
          "existingAiAccountName": {
            "value": "[parameters('aiFoundryResourceName')]"
          },
          "deployments": {
            "value": "[variables('aiProjectDeployments')]"
          },
          "connections": {
            "value": "[variables('aiProjectConnections')]"
          },
          "additionalDependentResources": {
            "value": "[variables('dependentResources')]"
          },
          "enableMonitoring": {
            "value": "[parameters('enableMonitoring')]"
          },
          "enableHostedAgents": {
            "value": "[parameters('enableHostedAgents')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "13407623912607311614"
            }
          },
          "definitions": {
            "deploymentsType": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "metadata": {
                      "description": "Specify the name of cognitive service account deployment."
                    }
                  },
                  "model": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string",
                        "metadata": {
                          "description": "Required. The name of Cognitive Services account deployment model."
                        }
                      },
                      "format": {
                        "type": "string",
                        "metadata": {
                          "description": "Required. The format of Cognitive Services account deployment model."
                        }
                      },
                      "version": {
                        "type": "string",
                        "metadata": {
                          "description": "Required. The version of Cognitive Services account deployment model."
                        }
                      }
                    },
                    "metadata": {
                      "description": "Required. Properties of Cognitive Services account deployment model."
                    }
                  },
                  "sku": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string",
                        "metadata": {
                          "description": "Required. The name of the resource model definition representing SKU."
                        }
                      },
                      "capacity": {
                        "type": "int",
                        "metadata": {
                          "description": "The capacity of the resource model definition representing SKU."
                        }
                      }
                    },
                    "metadata": {
                      "description": "The resource model definition representing SKU."
                    }
                  }
                }
              },
              "nullable": true
            },
            "dependentResourcesType": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "resource": {
                    "type": "string",
                    "allowedValues": [
                      "azure_ai_search",
                      "bing_custom_grounding",
                      "bing_grounding",
                      "registry",
                      "storage"
                    ],
                    "metadata": {
                      "description": "The type of dependent resource to create"
                    }
                  },
                  "connectionName": {
                    "type": "string",
                    "metadata": {
                      "description": "The connection name for this resource"
                    }
                  }
                }
              }
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags that will be applied to all resources"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Main location for the resources"
              }
            },
            "aiFoundryProjectName": {
              "type": "string",
              "metadata": {
                "description": "Name of the project"
              }
            },
            "deployments": {
              "$ref": "#/definitions/deploymentsType"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Id of the user or app to assign application roles"
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "Principal type of user or app"
              }
            },
            "existingAiAccountName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Name of an existing AI Services account in the current resource group. If not provided, a new one will be created."
              }
            },
            "connections": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "List of connections to provision"
              }
            },
            "additionalDependentResources": {
              "$ref": "#/definitions/dependentResourcesType",
              "metadata": {
                "description": "Also provision dependent resources and connect to the project"
              }
            },
            "enableMonitoring": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable monitoring via appinsights and log analytics"
              }
            },
            "enableHostedAgents": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable hosted agent deployment"
              }
            }
          },
          "variables": {
            "$fxv#0": {
              "aiFoundryAccounts": "aif",
              "analysisServicesServers": "as",
              "apiManagementService": "apim-",
              "appConfigurationStores": "appcs-",
              "appManagedEnvironments": "cae-",
              "appContainerApps": "ca-",
              "authorizationPolicyDefinitions": "policy-",
              "automationAutomationAccounts": "aa-",
              "blueprintBlueprints": "bp-",
              "blueprintBlueprintsArtifacts": "bpa-",
              "cacheRedis": "redis-",
              "cdnProfiles": "cdnp-",
              "cdnProfilesEndpoints": "cdne-",
              "cognitiveServicesAccounts": "cog-",
              "cognitiveServicesFormRecognizer": "cog-fr-",
              "cognitiveServicesTextAnalytics": "cog-ta-",
              "computeAvailabilitySets": "avail-",
              "computeCloudServices": "cld-",
              "computeDiskEncryptionSets": "des",
              "computeDisks": "disk",
              "computeDisksOs": "osdisk",
              "computeGalleries": "gal",
              "computeSnapshots": "snap-",
              "computeVirtualMachines": "vm",
              "computeVirtualMachineScaleSets": "vmss-",
              "containerInstanceContainerGroups": "ci",
              "containerRegistryRegistries": "cr",
              "containerServiceManagedClusters": "aks-",
              "databricksWorkspaces": "dbw-",
              "dataFactoryFactories": "adf-",
              "dataLakeAnalyticsAccounts": "dla",
              "dataLakeStoreAccounts": "dls",
              "dataMigrationServices": "dms-",
              "dBforMySQLServers": "mysql-",
              "dBforPostgreSQLServers": "psql-",
              "devicesIotHubs": "iot-",
              "devicesProvisioningServices": "provs-",
              "devicesProvisioningServicesCertificates": "pcert-",
              "documentDBDatabaseAccounts": "cosmos-",
              "documentDBMongoDatabaseAccounts": "cosmon-",
              "eventGridDomains": "evgd-",
              "eventGridDomainsTopics": "evgt-",
              "eventGridEventSubscriptions": "evgs-",
              "eventHubNamespaces": "evhns-",
              "eventHubNamespacesEventHubs": "evh-",
              "hdInsightClustersHadoop": "hadoop-",
              "hdInsightClustersHbase": "hbase-",
              "hdInsightClustersKafka": "kafka-",
              "hdInsightClustersMl": "mls-",
              "hdInsightClustersSpark": "spark-",
              "hdInsightClustersStorm": "storm-",
              "hybridComputeMachines": "arcs-",
              "insightsActionGroups": "ag-",
              "insightsComponents": "appi-",
              "keyVaultVaults": "kv-",
              "kubernetesConnectedClusters": "arck",
              "kustoClusters": "dec",
              "kustoClustersDatabases": "dedb",
              "logicIntegrationAccounts": "ia-",
              "logicWorkflows": "logic-",
              "machineLearningServicesWorkspaces": "mlw-",
              "managedIdentityUserAssignedIdentities": "id-",
              "managementManagementGroups": "mg-",
              "migrateAssessmentProjects": "migr-",
              "networkApplicationGateways": "agw-",
              "networkApplicationSecurityGroups": "asg-",
              "networkAzureFirewalls": "afw-",
              "networkBastionHosts": "bas-",
              "networkConnections": "con-",
              "networkDnsZones": "dnsz-",
              "networkExpressRouteCircuits": "erc-",
              "networkFirewallPolicies": "afwp-",
              "networkFirewallPoliciesWebApplication": "waf",
              "networkFirewallPoliciesRuleGroups": "wafrg",
              "networkFrontDoors": "fd-",
              "networkFrontdoorWebApplicationFirewallPolicies": "fdfp-",
              "networkLoadBalancersExternal": "lbe-",
              "networkLoadBalancersInternal": "lbi-",
              "networkLoadBalancersInboundNatRules": "rule-",
              "networkLocalNetworkGateways": "lgw-",
              "networkNatGateways": "ng-",
              "networkNetworkInterfaces": "nic-",
              "networkNetworkSecurityGroups": "nsg-",
              "networkNetworkSecurityGroupsSecurityRules": "nsgsr-",
              "networkNetworkWatchers": "nw-",
              "networkPrivateDnsZones": "pdnsz-",
              "networkPrivateLinkServices": "pl-",
              "networkPublicIPAddresses": "pip-",
              "networkPublicIPPrefixes": "ippre-",
              "networkRouteFilters": "rf-",
              "networkRouteTables": "rt-",
              "networkRouteTablesRoutes": "udr-",
              "networkTrafficManagerProfiles": "traf-",
              "networkVirtualNetworkGateways": "vgw-",
              "networkVirtualNetworks": "vnet-",
              "networkVirtualNetworksSubnets": "snet-",
              "networkVirtualNetworksVirtualNetworkPeerings": "peer-",
              "networkVirtualWans": "vwan-",
              "networkVpnGateways": "vpng-",
              "networkVpnGatewaysVpnConnections": "vcn-",
              "networkVpnGatewaysVpnSites": "vst-",
              "notificationHubsNamespaces": "ntfns-",
              "notificationHubsNamespacesNotificationHubs": "ntf-",
              "operationalInsightsWorkspaces": "log-",
              "portalDashboards": "dash-",
              "powerBIDedicatedCapacities": "pbi-",
              "purviewAccounts": "pview-",
              "recoveryServicesVaults": "rsv-",
              "resourcesResourceGroups": "rg-",
              "searchSearchServices": "srch-",
              "serviceBusNamespaces": "sb-",
              "serviceBusNamespacesQueues": "sbq-",
              "serviceBusNamespacesTopics": "sbt-",
              "serviceEndPointPolicies": "se-",
              "serviceFabricClusters": "sf-",
              "signalRServiceSignalR": "sigr",
              "sqlManagedInstances": "sqlmi-",
              "sqlServers": "sql-",
              "sqlServersDataWarehouse": "sqldw-",
              "sqlServersDatabases": "sqldb-",
              "sqlServersDatabasesStretch": "sqlstrdb-",
              "storageStorageAccounts": "st",
              "storageStorageAccountsVm": "stvm",
              "storSimpleManagers": "ssimp",
              "streamAnalyticsCluster": "asa-",
              "synapseWorkspaces": "syn",
              "synapseWorkspacesAnalyticsWorkspaces": "synw",
              "synapseWorkspacesSqlPoolsDedicated": "syndp",
              "synapseWorkspacesSqlPoolsSpark": "synsp",
              "timeSeriesInsightsEnvironments": "tsi-",
              "webServerFarms": "plan-",
              "webSitesAppService": "app-",
              "webSitesAppServiceEnvironment": "ase-",
              "webSitesFunctions": "func-",
              "webStaticSites": "stapp-"
            },
            "resourceToken": "[uniqueString(subscription().id, resourceGroup().id, parameters('location'))]",
            "abbrs": "[variables('$fxv#0')]",
            "hasStorageConnection": "[greater(length(filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'storage')))), 0)]",
            "hasAcrConnection": "[greater(length(filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'registry')))), 0)]",
            "hasSearchConnection": "[greater(length(filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'azure_ai_search')))), 0)]",
            "hasBingConnection": "[greater(length(filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'bing_grounding')))), 0)]",
            "hasBingCustomConnection": "[greater(length(filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'bing_custom_grounding')))), 0)]",
            "storageConnectionName": "[if(variables('hasStorageConnection'), filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'storage')))[0].connectionName, '')]",
            "acrConnectionName": "[if(variables('hasAcrConnection'), filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'registry')))[0].connectionName, '')]",
            "searchConnectionName": "[if(variables('hasSearchConnection'), filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'azure_ai_search')))[0].connectionName, '')]",
            "bingConnectionName": "[if(variables('hasBingConnection'), filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'bing_grounding')))[0].connectionName, '')]",
            "bingCustomConnectionName": "[if(variables('hasBingCustomConnection'), filter(parameters('additionalDependentResources'), lambda('conn', equals(lambdaVariables('conn').resource, 'bing_custom_grounding')))[0].connectionName, '')]"
          },
          "resources": {
            "aiAccount::seqDeployments": {
              "copy": {
                "name": "aiAccount::seqDeployments",
                "count": "[length(coalesce(parameters('deployments'), createArray()))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))), coalesce(parameters('deployments'), createArray())[copyIndex()].name)]",
              "properties": {
                "model": "[coalesce(parameters('deployments'), createArray())[copyIndex()].model]"
              },
              "sku": "[coalesce(parameters('deployments'), createArray())[copyIndex()].sku]",
              "dependsOn": [
                "aiAccount"
              ]
            },
            "aiAccount::project": {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))), parameters('aiFoundryProjectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "description": "[format('{0} Project', parameters('aiFoundryProjectName'))]",
                "displayName": "[format('{0}Project', parameters('aiFoundryProjectName'))]"
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::seqDeployments"
              ]
            },
            "aiAccount::aiFoundryAccountCapabilityHost": {
              "condition": "[parameters('enableHostedAgents')]",
              "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
              "apiVersion": "2025-10-01-preview",
              "name": "[format('{0}/{1}', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))), 'agents')]",
              "properties": {
                "capabilityHostKind": "Agents",
                "enablePublicHostingEnvironment": true
              },
              "dependsOn": [
                "aiAccount"
              ]
            },
            "aiAccount": {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "S0"
              },
              "kind": "AIServices",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "allowProjectManagement": true,
                "customSubDomainName": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": true
              }
            },
            "appInsightConnection": {
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))), parameters('aiFoundryProjectName'), 'appi-connection')]",
              "properties": {
                "category": "AppInsights",
                "target": "[reference('applicationInsights').outputs.id.value]",
                "authType": "ApiKey",
                "isSharedToAll": true,
                "credentials": {
                  "key": "[reference('applicationInsights').outputs.connectionString.value]"
                },
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[reference('applicationInsights').outputs.id.value]"
                }
              },
              "dependsOn": [
                "aiAccount::project",
                "applicationInsights"
              ]
            },
            "localUserAiDeveloperRoleAssignment": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), '64702f94-c441-49e6-a78b-ef80e0188fee')]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '64702f94-c441-49e6-a78b-ef80e0188fee')]"
              }
            },
            "localUserCognitiveServicesUserRoleAssignment": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]"
              }
            },
            "projectCognitiveServicesUserRoleAssignment": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))))]",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('aiFoundryProjectName'), '53ca6127-db72-4b80-b1b0-d745d6d5456d')]",
              "properties": {
                "principalId": "[reference('aiAccount::project', '2025-06-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '53ca6127-db72-4b80-b1b0-d745d6d5456d')]"
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "logAnalytics": {
              "condition": "[parameters('enableMonitoring')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "logAnalytics",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "name": {
                    "value": "[format('logs-{0}', variables('resourceToken'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "3822175714218311065"
                    },
                    "description": "Creates a Log Analytics workspace."
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2021-12-01-preview",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "retentionInDays": 30,
                        "features": {
                          "searchVersion": 1
                        },
                        "sku": {
                          "name": "PerGB2018"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            "applicationInsights": {
              "condition": "[parameters('enableMonitoring')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "applicationInsights",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "name": {
                    "value": "[format('appi-{0}', variables('resourceToken'))]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[reference('logAnalytics').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "16604112428187932121"
                    },
                    "description": "Creates an Application Insights instance based on an existing Log Analytics workspace."
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "dashboardName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('dashboardName')))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "application-insights-dashboard",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('dashboardName')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "applicationInsightsName": {
                            "value": "[parameters('name')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "65203899895817908"
                            },
                            "description": "Creates a dashboard for an Application Insights instance."
                          },
                          "parameters": {
                            "name": {
                              "type": "string"
                            },
                            "applicationInsightsName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Portal/dashboards",
                              "apiVersion": "2020-09-01-preview",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "lenses": [
                                  {
                                    "order": 0,
                                    "parts": [
                                      {
                                        "position": {
                                          "x": 0,
                                          "y": 0,
                                          "colSpan": 2,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "id",
                                              "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                            },
                                            {
                                              "name": "Version",
                                              "value": "1.0"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/AspNetOverviewPinnedPart",
                                          "asset": {
                                            "idInputName": "id",
                                            "type": "ApplicationInsights"
                                          },
                                          "defaultMenuItemId": "overview"
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 2,
                                          "y": 0,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "Version",
                                              "value": "1.0"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/ProactiveDetectionAsyncPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          },
                                          "defaultMenuItemId": "ProactiveDetection"
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 3,
                                          "y": 0,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "ResourceId",
                                              "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/QuickPulseButtonSmallPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 4,
                                          "y": 0,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "TimeContext",
                                              "value": {
                                                "durationMs": 86400000,
                                                "endTime": null,
                                                "createdTime": "2018-05-04T01:20:33.345Z",
                                                "isInitialTime": true,
                                                "grain": 1,
                                                "useDashboardTimeRange": false
                                              }
                                            },
                                            {
                                              "name": "Version",
                                              "value": "1.0"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/AvailabilityNavButtonPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 5,
                                          "y": 0,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "TimeContext",
                                              "value": {
                                                "durationMs": 86400000,
                                                "endTime": null,
                                                "createdTime": "2018-05-08T18:47:35.237Z",
                                                "isInitialTime": true,
                                                "grain": 1,
                                                "useDashboardTimeRange": false
                                              }
                                            },
                                            {
                                              "name": "ConfigurationId",
                                              "value": "78ce933e-e864-4b05-a27b-71fd55a6afad"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/AppMapButtonPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 0,
                                          "y": 1,
                                          "colSpan": 3,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [],
                                          "type": "Extension/HubsExtension/PartType/MarkdownPart",
                                          "settings": {
                                            "content": {
                                              "settings": {
                                                "content": "# Usage",
                                                "title": "",
                                                "subtitle": ""
                                              }
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 3,
                                          "y": 1,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "TimeContext",
                                              "value": {
                                                "durationMs": 86400000,
                                                "endTime": null,
                                                "createdTime": "2018-05-04T01:22:35.782Z",
                                                "isInitialTime": true,
                                                "grain": 1,
                                                "useDashboardTimeRange": false
                                              }
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/UsageUsersOverviewPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 4,
                                          "y": 1,
                                          "colSpan": 3,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [],
                                          "type": "Extension/HubsExtension/PartType/MarkdownPart",
                                          "settings": {
                                            "content": {
                                              "settings": {
                                                "content": "# Reliability",
                                                "title": "",
                                                "subtitle": ""
                                              }
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 7,
                                          "y": 1,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ResourceId",
                                              "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                            },
                                            {
                                              "name": "DataModel",
                                              "value": {
                                                "version": "1.0.0",
                                                "timeContext": {
                                                  "durationMs": 86400000,
                                                  "createdTime": "2018-05-04T23:42:40.072Z",
                                                  "isInitialTime": false,
                                                  "grain": 1,
                                                  "useDashboardTimeRange": false
                                                }
                                              },
                                              "isOptional": true
                                            },
                                            {
                                              "name": "ConfigurationId",
                                              "value": "8a02f7bf-ac0f-40e1-afe9-f0e72cfee77f",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/CuratedBladeFailuresPinnedPart",
                                          "isAdapter": true,
                                          "asset": {
                                            "idInputName": "ResourceId",
                                            "type": "ApplicationInsights"
                                          },
                                          "defaultMenuItemId": "failures"
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 8,
                                          "y": 1,
                                          "colSpan": 3,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [],
                                          "type": "Extension/HubsExtension/PartType/MarkdownPart",
                                          "settings": {
                                            "content": {
                                              "settings": {
                                                "content": "# Responsiveness\r\n",
                                                "title": "",
                                                "subtitle": ""
                                              }
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 11,
                                          "y": 1,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ResourceId",
                                              "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                            },
                                            {
                                              "name": "DataModel",
                                              "value": {
                                                "version": "1.0.0",
                                                "timeContext": {
                                                  "durationMs": 86400000,
                                                  "createdTime": "2018-05-04T23:43:37.804Z",
                                                  "isInitialTime": false,
                                                  "grain": 1,
                                                  "useDashboardTimeRange": false
                                                }
                                              },
                                              "isOptional": true
                                            },
                                            {
                                              "name": "ConfigurationId",
                                              "value": "2a8ede4f-2bee-4b9c-aed9-2db0e8a01865",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/CuratedBladePerformancePinnedPart",
                                          "isAdapter": true,
                                          "asset": {
                                            "idInputName": "ResourceId",
                                            "type": "ApplicationInsights"
                                          },
                                          "defaultMenuItemId": "performance"
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 12,
                                          "y": 1,
                                          "colSpan": 3,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [],
                                          "type": "Extension/HubsExtension/PartType/MarkdownPart",
                                          "settings": {
                                            "content": {
                                              "settings": {
                                                "content": "# Browser",
                                                "title": "",
                                                "subtitle": ""
                                              }
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 15,
                                          "y": 1,
                                          "colSpan": 1,
                                          "rowSpan": 1
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "ComponentId",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "MetricsExplorerJsonDefinitionId",
                                              "value": "BrowserPerformanceTimelineMetrics"
                                            },
                                            {
                                              "name": "TimeContext",
                                              "value": {
                                                "durationMs": 86400000,
                                                "createdTime": "2018-05-08T12:16:27.534Z",
                                                "isInitialTime": false,
                                                "grain": 1,
                                                "useDashboardTimeRange": false
                                              }
                                            },
                                            {
                                              "name": "CurrentFilter",
                                              "value": {
                                                "eventTypes": [
                                                  4,
                                                  1,
                                                  3,
                                                  5,
                                                  2,
                                                  6,
                                                  13
                                                ],
                                                "typeFacets": {},
                                                "isPermissive": false
                                              }
                                            },
                                            {
                                              "name": "id",
                                              "value": {
                                                "Name": "[parameters('applicationInsightsName')]",
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]"
                                              }
                                            },
                                            {
                                              "name": "Version",
                                              "value": "1.0"
                                            }
                                          ],
                                          "type": "Extension/AppInsightsExtension/PartType/MetricsExplorerBladePinnedPart",
                                          "asset": {
                                            "idInputName": "ComponentId",
                                            "type": "ApplicationInsights"
                                          },
                                          "defaultMenuItemId": "browser"
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 0,
                                          "y": 2,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "sessions/count",
                                                      "aggregationType": 5,
                                                      "namespace": "microsoft.insights/components/kusto",
                                                      "metricVisualization": {
                                                        "displayName": "Sessions",
                                                        "color": "#47BDF5"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "users/count",
                                                      "aggregationType": 5,
                                                      "namespace": "microsoft.insights/components/kusto",
                                                      "metricVisualization": {
                                                        "displayName": "Users",
                                                        "color": "#7E58FF"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Unique sessions and users",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  },
                                                  "openBladeOnClick": {
                                                    "openBlade": true,
                                                    "destinationBlade": {
                                                      "extensionName": "HubsExtension",
                                                      "bladeName": "ResourceMenuBlade",
                                                      "parameters": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]",
                                                        "menuid": "segmentationUsers"
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 4,
                                          "y": 2,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "requests/failed",
                                                      "aggregationType": 7,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Failed requests",
                                                        "color": "#EC008C"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Failed requests",
                                                  "visualization": {
                                                    "chartType": 3,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  },
                                                  "openBladeOnClick": {
                                                    "openBlade": true,
                                                    "destinationBlade": {
                                                      "extensionName": "HubsExtension",
                                                      "bladeName": "ResourceMenuBlade",
                                                      "parameters": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]",
                                                        "menuid": "failures"
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 8,
                                          "y": 2,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "requests/duration",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Server response time",
                                                        "color": "#00BCF2"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Server response time",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  },
                                                  "openBladeOnClick": {
                                                    "openBlade": true,
                                                    "destinationBlade": {
                                                      "extensionName": "HubsExtension",
                                                      "bladeName": "ResourceMenuBlade",
                                                      "parameters": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]",
                                                        "menuid": "performance"
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 12,
                                          "y": 2,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "browserTimings/networkDuration",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Page load network connect time",
                                                        "color": "#7E58FF"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "browserTimings/processingDuration",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Client processing time",
                                                        "color": "#44F1C8"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "browserTimings/sendDuration",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Send request time",
                                                        "color": "#EB9371"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "browserTimings/receiveDuration",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Receiving response time",
                                                        "color": "#0672F1"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Average page load time breakdown",
                                                  "visualization": {
                                                    "chartType": 3,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 0,
                                          "y": 5,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "availabilityResults/availabilityPercentage",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Availability",
                                                        "color": "#47BDF5"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Average availability",
                                                  "visualization": {
                                                    "chartType": 3,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  },
                                                  "openBladeOnClick": {
                                                    "openBlade": true,
                                                    "destinationBlade": {
                                                      "extensionName": "HubsExtension",
                                                      "bladeName": "ResourceMenuBlade",
                                                      "parameters": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]",
                                                        "menuid": "availability"
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 4,
                                          "y": 5,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "exceptions/server",
                                                      "aggregationType": 7,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Server exceptions",
                                                        "color": "#47BDF5"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "dependencies/failed",
                                                      "aggregationType": 7,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Dependency failures",
                                                        "color": "#7E58FF"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Server exceptions and Dependency failures",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 8,
                                          "y": 5,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "performanceCounters/processorCpuPercentage",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Processor time",
                                                        "color": "#47BDF5"
                                                      }
                                                    },
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "performanceCounters/processCpuPercentage",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Process CPU",
                                                        "color": "#7E58FF"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Average processor and process CPU utilization",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 12,
                                          "y": 5,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "exceptions/browser",
                                                      "aggregationType": 7,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Browser exceptions",
                                                        "color": "#47BDF5"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Browser exceptions",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 0,
                                          "y": 8,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "availabilityResults/count",
                                                      "aggregationType": 7,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Availability test results count",
                                                        "color": "#47BDF5"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Availability test results count",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 4,
                                          "y": 8,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "performanceCounters/processIOBytesPerSecond",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Process IO rate",
                                                        "color": "#47BDF5"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Average process I/O rate",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      },
                                      {
                                        "position": {
                                          "x": 8,
                                          "y": 8,
                                          "colSpan": 4,
                                          "rowSpan": 3
                                        },
                                        "metadata": {
                                          "inputs": [
                                            {
                                              "name": "options",
                                              "value": {
                                                "chart": {
                                                  "metrics": [
                                                    {
                                                      "resourceMetadata": {
                                                        "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Insights/components/{2}', subscription().subscriptionId, resourceGroup().name, parameters('applicationInsightsName'))]"
                                                      },
                                                      "name": "performanceCounters/memoryAvailableBytes",
                                                      "aggregationType": 4,
                                                      "namespace": "microsoft.insights/components",
                                                      "metricVisualization": {
                                                        "displayName": "Available memory",
                                                        "color": "#47BDF5"
                                                      }
                                                    }
                                                  ],
                                                  "title": "Average available memory",
                                                  "visualization": {
                                                    "chartType": 2,
                                                    "legendVisualization": {
                                                      "isVisible": true,
                                                      "position": 2,
                                                      "hideSubtitle": false
                                                    },
                                                    "axisVisualization": {
                                                      "x": {
                                                        "isVisible": true,
                                                        "axisType": 2
                                                      },
                                                      "y": {
                                                        "isVisible": true,
                                                        "axisType": 1
                                                      }
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "name": "sharedTimeRange",
                                              "isOptional": true
                                            }
                                          ],
                                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                          "settings": {}
                                        }
                                      }
                                    ]
                                  }
                                ]
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "connectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                    },
                    "instrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "logAnalytics"
              ]
            },
            "aiConnections": {
              "copy": {
                "name": "aiConnections",
                "count": "[length(parameters('connections'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('connection-{0}', parameters('connections')[copyIndex()].name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  },
                  "connectionConfig": {
                    "value": {
                      "name": "[parameters('connections')[copyIndex()].name]",
                      "category": "[parameters('connections')[copyIndex()].category]",
                      "target": "[parameters('connections')[copyIndex()].target]",
                      "authType": "[parameters('connections')[copyIndex()].authType]"
                    }
                  },
                  "apiKey": {
                    "value": ""
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "16558283348227387412"
                    }
                  },
                  "definitions": {
                    "ConnectionConfig": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Name of the connection"
                          }
                        },
                        "category": {
                          "type": "string",
                          "metadata": {
                            "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                          }
                        },
                        "target": {
                          "type": "string",
                          "metadata": {
                            "description": "Target endpoint or URL for the connection"
                          }
                        },
                        "authType": {
                          "type": "string",
                          "allowedValues": [
                            "AAD",
                            "AccessKey",
                            "AccountKey",
                            "ApiKey",
                            "CustomKeys",
                            "ManagedIdentity",
                            "None",
                            "OAuth2",
                            "PAT",
                            "SAS",
                            "ServicePrincipal",
                            "UsernamePassword"
                          ],
                          "metadata": {
                            "description": "Authentication type"
                          }
                        },
                        "isSharedToAll": {
                          "type": "bool",
                          "nullable": true,
                          "metadata": {
                            "description": "Whether the connection is shared to all users (optional, defaults to true)"
                          }
                        },
                        "credentials": {
                          "type": "object",
                          "nullable": true,
                          "metadata": {
                            "description": "Credentials for non-ApiKey authentication types (optional)"
                          }
                        },
                        "metadata": {
                          "type": "object",
                          "nullable": true,
                          "metadata": {
                            "description": "Additional metadata for the connection (optional)"
                          }
                        }
                      }
                    }
                  },
                  "parameters": {
                    "aiServicesAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "AI Services account name"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "metadata": {
                        "description": "AI project name"
                      }
                    },
                    "connectionConfig": {
                      "$ref": "#/definitions/ConnectionConfig",
                      "metadata": {
                        "description": "Connection configuration"
                      }
                    },
                    "apiKey": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "API key for ApiKey based connections (optional)"
                      }
                    }
                  },
                  "resources": {
                    "aiAccount::project": {
                      "existing": true,
                      "type": "Microsoft.CognitiveServices/accounts/projects",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                    },
                    "aiAccount": {
                      "existing": true,
                      "type": "Microsoft.CognitiveServices/accounts",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[parameters('aiServicesAccountName')]"
                    },
                    "connection": {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                      "properties": {
                        "category": "[parameters('connectionConfig').category]",
                        "target": "[parameters('connectionConfig').target]",
                        "authType": "[parameters('connectionConfig').authType]",
                        "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                        "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                        "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                      }
                    }
                  },
                  "outputs": {
                    "connectionName": {
                      "type": "string",
                      "value": "[parameters('connectionConfig').name]"
                    },
                    "connectionId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "storage": {
              "condition": "[variables('hasStorageConnection')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "resourceName": {
                    "value": "[format('st{0}', variables('resourceToken'))]"
                  },
                  "connectionName": {
                    "value": "[variables('storageConnectionName')]"
                  },
                  "principalId": {
                    "value": "[parameters('principalId')]"
                  },
                  "principalType": {
                    "value": "[parameters('principalType')]"
                  },
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "17185764980292520843"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The location used for all deployed resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags that will be applied to all resources"
                      }
                    },
                    "resourceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Storage account resource name"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Id of the user or app to assign application roles"
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal type of user or app"
                      }
                    },
                    "aiServicesAccountName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI Services account name for the project parent"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI project name for creating the connection"
                      }
                    },
                    "connectionName": {
                      "type": "string",
                      "defaultValue": "storage-connection",
                      "metadata": {
                        "description": "Name for the AI Foundry storage connection"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('resourceName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "Standard_LRS"
                      },
                      "kind": "StorageV2",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "supportsHttpsTrafficOnly": true,
                        "allowBlobPublicAccess": false,
                        "minimumTlsVersion": "TLS1_2",
                        "accessTier": "Hot",
                        "encryption": {
                          "services": {
                            "blob": {
                              "enabled": true
                            },
                            "file": {
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        }
                      }
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('resourceName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesAccountName')), 'ai-storage-contributor')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('resourceName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), parameters('principalId'), 'Storage Blob Data Contributor')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "[parameters('principalType')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "storage-connection-creation",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "aiServicesAccountName": {
                            "value": "[parameters('aiServicesAccountName')]"
                          },
                          "aiProjectName": {
                            "value": "[parameters('aiProjectName')]"
                          },
                          "connectionConfig": {
                            "value": {
                              "name": "[parameters('connectionName')]",
                              "category": "AzureStorageAccount",
                              "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), '2023-05-01').primaryEndpoints.blob]",
                              "authType": "AAD",
                              "isSharedToAll": true,
                              "metadata": {
                                "ApiType": "Azure",
                                "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName'))]",
                                "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), '2023-05-01', 'full').location]"
                              }
                            }
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16558283348227387412"
                            }
                          },
                          "definitions": {
                            "ConnectionConfig": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Name of the connection"
                                  }
                                },
                                "category": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                                  }
                                },
                                "target": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Target endpoint or URL for the connection"
                                  }
                                },
                                "authType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AAD",
                                    "AccessKey",
                                    "AccountKey",
                                    "ApiKey",
                                    "CustomKeys",
                                    "ManagedIdentity",
                                    "None",
                                    "OAuth2",
                                    "PAT",
                                    "SAS",
                                    "ServicePrincipal",
                                    "UsernamePassword"
                                  ],
                                  "metadata": {
                                    "description": "Authentication type"
                                  }
                                },
                                "isSharedToAll": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Whether the connection is shared to all users (optional, defaults to true)"
                                  }
                                },
                                "credentials": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Credentials for non-ApiKey authentication types (optional)"
                                  }
                                },
                                "metadata": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Additional metadata for the connection (optional)"
                                  }
                                }
                              }
                            }
                          },
                          "parameters": {
                            "aiServicesAccountName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI Services account name"
                              }
                            },
                            "aiProjectName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI project name"
                              }
                            },
                            "connectionConfig": {
                              "$ref": "#/definitions/ConnectionConfig",
                              "metadata": {
                                "description": "Connection configuration"
                              }
                            },
                            "apiKey": {
                              "type": "securestring",
                              "defaultValue": "",
                              "metadata": {
                                "description": "API key for ApiKey based connections (optional)"
                              }
                            }
                          },
                          "resources": {
                            "aiAccount::project": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                            },
                            "aiAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[parameters('aiServicesAccountName')]"
                            },
                            "connection": {
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                              "properties": {
                                "category": "[parameters('connectionConfig').category]",
                                "target": "[parameters('connectionConfig').target]",
                                "authType": "[parameters('connectionConfig').authType]",
                                "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                                "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                                "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                              }
                            }
                          },
                          "outputs": {
                            "connectionName": {
                              "type": "string",
                              "value": "[parameters('connectionConfig').name]"
                            },
                            "connectionId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "storageAccountName": {
                      "type": "string",
                      "value": "[parameters('resourceName')]"
                    },
                    "storageAccountId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName'))]"
                    },
                    "storageAccountPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), '2023-05-01', 'full').identity.principalId]"
                    },
                    "storageConnectionName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-connection-creation'), '2025-04-01').outputs.connectionName.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "acr": {
              "condition": "[variables('hasAcrConnection')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "acr",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "resourceName": {
                    "value": "[format('{0}{1}', variables('abbrs').containerRegistryRegistries, variables('resourceToken'))]"
                  },
                  "connectionName": {
                    "value": "[variables('acrConnectionName')]"
                  },
                  "principalId": {
                    "value": "[parameters('principalId')]"
                  },
                  "principalType": {
                    "value": "[parameters('principalType')]"
                  },
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "13240036058708110858"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The location used for all deployed resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags that will be applied to all resources"
                      }
                    },
                    "resourceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource name for the container registry"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Id of the user or app to assign application roles"
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal type of user or app"
                      }
                    },
                    "aiServicesAccountName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI Services account name for the project parent"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI project name for creating the connection"
                      }
                    },
                    "connectionName": {
                      "type": "string",
                      "defaultValue": "acr-connection",
                      "metadata": {
                        "description": "Name for the AI Foundry ACR connection"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "registry",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('resourceName')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "publicNetworkAccess": {
                            "value": "Enabled"
                          },
                          "roleAssignments": {
                            "value": [
                              {
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]",
                                "roleDefinitionIdOrName": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                              },
                              {
                                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionIdOrName": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                              }
                            ]
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.25.53.49325",
                              "templateHash": "14346813384269118868"
                            },
                            "name": "Azure Container Registries (ACR)",
                            "description": "This module deploys an Azure Container Registry (ACR).",
                            "owner": "Azure/module-maintainers"
                          },
                          "definitions": {
                            "managedIdentitiesType": {
                              "type": "object",
                              "properties": {
                                "systemAssigned": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Enables system assigned managed identity on the resource."
                                  }
                                },
                                "userAssignedResourceIds": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The resource ID(s) to assign to the resource."
                                  }
                                }
                              },
                              "nullable": true
                            },
                            "lockType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of lock."
                                  }
                                },
                                "kind": {
                                  "type": "string",
                                  "allowedValues": [
                                    "CanNotDelete",
                                    "None",
                                    "ReadOnly"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the type of lock."
                                  }
                                }
                              },
                              "nullable": true
                            },
                            "roleAssignmentType": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "roleDefinitionIdOrName": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                    }
                                  },
                                  "principalId": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                    }
                                  },
                                  "principalType": {
                                    "type": "string",
                                    "allowedValues": [
                                      "Device",
                                      "ForeignGroup",
                                      "Group",
                                      "ServicePrincipal",
                                      "User"
                                    ],
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The principal type of the assigned principal ID."
                                    }
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The description of the role assignment."
                                    }
                                  },
                                  "condition": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                    }
                                  },
                                  "conditionVersion": {
                                    "type": "string",
                                    "allowedValues": [
                                      "2.0"
                                    ],
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Version of the condition."
                                    }
                                  },
                                  "delegatedManagedIdentityResourceId": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The Resource Id of the delegated managed identity resource."
                                    }
                                  }
                                }
                              },
                              "nullable": true
                            },
                            "privateEndpointType": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The name of the private endpoint."
                                    }
                                  },
                                  "location": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The location to deploy the private endpoint to."
                                    }
                                  },
                                  "service": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The service (sub-) type to deploy the private endpoint for. For example \"vault\" or \"blob\"."
                                    }
                                  },
                                  "subnetResourceId": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                    }
                                  },
                                  "privateDnsZoneGroupName": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The name of the private DNS zone group to create if privateDnsZoneResourceIds were provided."
                                    }
                                  },
                                  "privateDnsZoneResourceIds": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The private DNS zone groups to associate the private endpoint with. A DNS zone group can support up to 5 DNS zones."
                                    }
                                  },
                                  "customDnsConfigs": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Required. Fqdn that resolves to private endpoint ip address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private ip addresses of the private endpoint."
                                          }
                                        }
                                      }
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Custom DNS configurations."
                                    }
                                  },
                                  "ipConfigurations": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private ip address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      }
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                    }
                                  },
                                  "applicationSecurityGroupResourceIds": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                    }
                                  },
                                  "customNetworkInterfaceName": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                    }
                                  },
                                  "lock": {
                                    "$ref": "#/definitions/lockType",
                                    "metadata": {
                                      "description": "Optional. Specify the type of lock."
                                    }
                                  },
                                  "roleAssignments": {
                                    "$ref": "#/definitions/roleAssignmentType",
                                    "metadata": {
                                      "description": "Optional. Array of role assignments to create."
                                    }
                                  },
                                  "tags": {
                                    "type": "object",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                    }
                                  },
                                  "manualPrivateLinkServiceConnections": {
                                    "type": "array",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Manual PrivateLink Service Connections."
                                    }
                                  },
                                  "enableTelemetry": {
                                    "type": "bool",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Enable/Disable usage telemetry for module."
                                    }
                                  }
                                }
                              },
                              "nullable": true
                            },
                            "diagnosticSettingType": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The name of diagnostic setting."
                                    }
                                  },
                                  "logCategoriesAndGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "category": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                          }
                                        },
                                        "categoryGroup": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                          }
                                        },
                                        "enabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                          }
                                        }
                                      }
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                    }
                                  },
                                  "metricCategories": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "category": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                          }
                                        },
                                        "enabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                          }
                                        }
                                      }
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                    }
                                  },
                                  "logAnalyticsDestinationType": {
                                    "type": "string",
                                    "allowedValues": [
                                      "AzureDiagnostics",
                                      "Dedicated"
                                    ],
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                    }
                                  },
                                  "workspaceResourceId": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                    }
                                  },
                                  "storageAccountResourceId": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                    }
                                  },
                                  "eventHubAuthorizationRuleResourceId": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                    }
                                  },
                                  "eventHubName": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                    }
                                  },
                                  "marketplacePartnerResourceId": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                    }
                                  }
                                }
                              },
                              "nullable": true
                            },
                            "customerManagedKeyType": {
                              "type": "object",
                              "properties": {
                                "keyVaultResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The resource ID of a key vault to reference a customer managed key for encryption from."
                                  }
                                },
                                "keyName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The name of the customer managed key to use for encryption."
                                  }
                                },
                                "keyVersion": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, using 'latest'."
                                  }
                                },
                                "userAssignedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. User assigned identity to use when fetching the customer managed key. Required if no system assigned identity is available for use."
                                  }
                                }
                              },
                              "nullable": true
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "minLength": 5,
                              "maxLength": 50,
                              "metadata": {
                                "description": "Required. Name of your Azure Container Registry."
                              }
                            },
                            "acrAdminUserEnabled": {
                              "type": "bool",
                              "defaultValue": false,
                              "metadata": {
                                "description": "Optional. Enable admin user that have push / pull permission to the registry."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Location for all resources."
                              }
                            },
                            "roleAssignments": {
                              "$ref": "#/definitions/roleAssignmentType",
                              "metadata": {
                                "description": "Optional. Array of role assignments to create."
                              }
                            },
                            "acrSku": {
                              "type": "string",
                              "defaultValue": "Basic",
                              "allowedValues": [
                                "Basic",
                                "Premium",
                                "Standard"
                              ],
                              "metadata": {
                                "description": "Optional. Tier of your Azure container registry."
                              }
                            },
                            "exportPolicyStatus": {
                              "type": "string",
                              "defaultValue": "disabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. The value that indicates whether the export policy is enabled or not."
                              }
                            },
                            "quarantinePolicyStatus": {
                              "type": "string",
                              "defaultValue": "disabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. The value that indicates whether the quarantine policy is enabled or not."
                              }
                            },
                            "trustPolicyStatus": {
                              "type": "string",
                              "defaultValue": "disabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. The value that indicates whether the trust policy is enabled or not."
                              }
                            },
                            "retentionPolicyStatus": {
                              "type": "string",
                              "defaultValue": "enabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. The value that indicates whether the retention policy is enabled or not."
                              }
                            },
                            "retentionPolicyDays": {
                              "type": "int",
                              "defaultValue": 15,
                              "metadata": {
                                "description": "Optional. The number of days to retain an untagged manifest after which it gets purged."
                              }
                            },
                            "azureADAuthenticationAsArmPolicyStatus": {
                              "type": "string",
                              "defaultValue": "enabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. The value that indicates whether the policy for using ARM audience token for a container registr is enabled or not. Default is enabled."
                              }
                            },
                            "softDeletePolicyStatus": {
                              "type": "string",
                              "defaultValue": "disabled",
                              "allowedValues": [
                                "disabled",
                                "enabled"
                              ],
                              "metadata": {
                                "description": "Optional. Soft Delete policy status. Default is disabled."
                              }
                            },
                            "softDeletePolicyDays": {
                              "type": "int",
                              "defaultValue": 7,
                              "metadata": {
                                "description": "Optional. The number of days after which a soft-deleted item is permanently deleted."
                              }
                            },
                            "dataEndpointEnabled": {
                              "type": "bool",
                              "defaultValue": false,
                              "metadata": {
                                "description": "Optional. Enable a single data endpoint per region for serving data. Not relevant in case of disabled public access. Note, requires the 'acrSku' to be 'Premium'."
                              }
                            },
                            "publicNetworkAccess": {
                              "type": "string",
                              "nullable": true,
                              "allowedValues": [
                                "Enabled",
                                "Disabled"
                              ],
                              "metadata": {
                                "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled. If not specified, it will be disabled by default if private endpoints are set and networkRuleSetIpRules are not set.  Note, requires the 'acrSku' to be 'Premium'."
                              }
                            },
                            "networkRuleBypassOptions": {
                              "type": "string",
                              "defaultValue": "AzureServices",
                              "allowedValues": [
                                "AzureServices",
                                "None"
                              ],
                              "metadata": {
                                "description": "Optional. Whether to allow trusted Azure services to access a network restricted registry."
                              }
                            },
                            "networkRuleSetDefaultAction": {
                              "type": "string",
                              "defaultValue": "Deny",
                              "allowedValues": [
                                "Allow",
                                "Deny"
                              ],
                              "metadata": {
                                "description": "Optional. The default action of allow or deny when no other rules match."
                              }
                            },
                            "networkRuleSetIpRules": {
                              "type": "array",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The IP ACL rules. Note, requires the 'acrSku' to be 'Premium'."
                              }
                            },
                            "privateEndpoints": {
                              "$ref": "#/definitions/privateEndpointType",
                              "metadata": {
                                "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible. Note, requires the 'acrSku' to be 'Premium'."
                              }
                            },
                            "zoneRedundancy": {
                              "type": "string",
                              "defaultValue": "Disabled",
                              "allowedValues": [
                                "Disabled",
                                "Enabled"
                              ],
                              "metadata": {
                                "description": "Optional. Whether or not zone redundancy is enabled for this container registry."
                              }
                            },
                            "replications": {
                              "type": "array",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. All replications to create."
                              }
                            },
                            "webhooks": {
                              "type": "array",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. All webhooks to create."
                              }
                            },
                            "lock": {
                              "$ref": "#/definitions/lockType",
                              "metadata": {
                                "description": "Optional. The lock settings of the service."
                              }
                            },
                            "managedIdentities": {
                              "$ref": "#/definitions/managedIdentitiesType",
                              "metadata": {
                                "description": "Optional. The managed identity definition for this resource."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Tags of the resource."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "diagnosticSettings": {
                              "$ref": "#/definitions/diagnosticSettingType",
                              "metadata": {
                                "description": "Optional. The diagnostic settings of the service."
                              }
                            },
                            "anonymousPullEnabled": {
                              "type": "bool",
                              "defaultValue": false,
                              "metadata": {
                                "description": "Optional. Enables registry-wide pull from unauthenticated clients. It's in preview and available in the Standard and Premium service tiers."
                              }
                            },
                            "customerManagedKey": {
                              "$ref": "#/definitions/customerManagedKeyType",
                              "metadata": {
                                "description": "Optional. The customer managed key definition."
                              }
                            },
                            "cacheRules": {
                              "type": "array",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Array of Cache Rules. Note: This is a preview feature ([ref](https://learn.microsoft.com/en-us/azure/container-registry/tutorial-registry-cache#cache-for-acr-preview))."
                              }
                            }
                          },
                          "variables": {
                            "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                            "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', null())), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                            "builtInRoleNames": {
                              "AcrDelete": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c2f4ef07-c644-48eb-af81-4b1b4947fb11')]",
                              "AcrImageSigner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '6cef56e8-d556-48e5-a04f-b8e64114680f')]",
                              "AcrPull": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                              "AcrPush": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8311e382-0749-4cb8-b61a-304f252e45ec')]",
                              "AcrQuarantineReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'cdda3590-29a3-44f6-95f2-9f980659eb04')]",
                              "AcrQuarantineWriter": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c8d4ff99-41c3-41a8-9f60-21dfdad59608')]",
                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                              "Role Based Access Control Administrator (Preview)": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                              "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                            }
                          },
                          "resources": {
                            "cMKKeyVault::cMKKey": {
                              "condition": "[and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), not(empty(tryGet(parameters('customerManagedKey'), 'keyName')))))]",
                              "existing": true,
                              "type": "Microsoft.KeyVault/vaults/keys",
                              "apiVersion": "2023-02-01",
                              "subscriptionId": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '//'), '/')[2]]",
                              "resourceGroup": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '////'), '/')[4]]",
                              "name": "[format('{0}/{1}', last(split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), 'dummyVault'), '/')), coalesce(tryGet(parameters('customerManagedKey'), 'keyName'), 'dummyKey'))]",
                              "dependsOn": [
                                "cMKKeyVault"
                              ]
                            },
                            "avmTelemetry": {
                              "condition": "[parameters('enableTelemetry')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2023-07-01",
                              "name": "[format('46d3xbcp.res.containerregistry-registry.{0}.{1}', replace('0.1.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                              "properties": {
                                "mode": "Incremental",
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "resources": [],
                                  "outputs": {
                                    "telemetry": {
                                      "type": "String",
                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                    }
                                  }
                                }
                              }
                            },
                            "cMKKeyVault": {
                              "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2023-02-01",
                              "subscriptionId": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '//'), '/')[2]]",
                              "resourceGroup": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '////'), '/')[4]]",
                              "name": "[last(split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), 'dummyVault'), '/'))]"
                            },
                            "cMKUserAssignedIdentity": {
                              "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2023-01-31",
                              "subscriptionId": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '//'), '/')[2]]",
                              "resourceGroup": "[split(coalesce(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '////'), '/')[4]]",
                              "name": "[last(split(coalesce(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), 'dummyMsi'), '/'))]"
                            },
                            "registry": {
                              "type": "Microsoft.ContainerRegistry/registries",
                              "apiVersion": "2023-06-01-preview",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "identity": "[variables('identity')]",
                              "tags": "[parameters('tags')]",
                              "sku": {
                                "name": "[parameters('acrSku')]"
                              },
                              "properties": {
                                "anonymousPullEnabled": "[parameters('anonymousPullEnabled')]",
                                "adminUserEnabled": "[parameters('acrAdminUserEnabled')]",
                                "encryption": "[if(not(empty(parameters('customerManagedKey'))), createObject('status', 'enabled', 'keyVaultProperties', createObject('identity', if(not(empty(coalesce(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), ''))), reference('cMKUserAssignedIdentity').clientId, null()), 'keyIdentifier', if(not(empty(coalesce(tryGet(parameters('customerManagedKey'), 'keyVersion'), ''))), format('{0}/{1}', reference('cMKKeyVault::cMKKey').keyUri, parameters('customerManagedKey').keyVersion), reference('cMKKeyVault::cMKKey').keyUriWithVersion))), null())]",
                                "policies": {
                                  "azureADAuthenticationAsArmPolicy": {
                                    "status": "[parameters('azureADAuthenticationAsArmPolicyStatus')]"
                                  },
                                  "exportPolicy": "[if(equals(parameters('acrSku'), 'Premium'), createObject('status', parameters('exportPolicyStatus')), null())]",
                                  "quarantinePolicy": {
                                    "status": "[parameters('quarantinePolicyStatus')]"
                                  },
                                  "trustPolicy": {
                                    "type": "Notary",
                                    "status": "[parameters('trustPolicyStatus')]"
                                  },
                                  "retentionPolicy": "[if(equals(parameters('acrSku'), 'Premium'), createObject('days', parameters('retentionPolicyDays'), 'status', parameters('retentionPolicyStatus')), null())]",
                                  "softDeletePolicy": {
                                    "retentionDays": "[parameters('softDeletePolicyDays')]",
                                    "status": "[parameters('softDeletePolicyStatus')]"
                                  }
                                },
                                "dataEndpointEnabled": "[parameters('dataEndpointEnabled')]",
                                "publicNetworkAccess": "[if(not(empty(parameters('publicNetworkAccess'))), parameters('publicNetworkAccess'), if(and(not(empty(parameters('privateEndpoints'))), empty(parameters('networkRuleSetIpRules'))), 'Disabled', null()))]",
                                "networkRuleBypassOptions": "[parameters('networkRuleBypassOptions')]",
                                "networkRuleSet": "[if(not(empty(parameters('networkRuleSetIpRules'))), createObject('defaultAction', parameters('networkRuleSetDefaultAction'), 'ipRules', parameters('networkRuleSetIpRules')), null())]",
                                "zoneRedundancy": "[if(equals(parameters('acrSku'), 'Premium'), parameters('zoneRedundancy'), null())]"
                              },
                              "dependsOn": [
                                "cMKKeyVault",
                                "cMKUserAssignedIdentity"
                              ]
                            },
                            "registry_lock": {
                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                              "type": "Microsoft.Authorization/locks",
                              "apiVersion": "2020-05-01",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                              "properties": {
                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_diagnosticSettings": {
                              "copy": {
                                "name": "registry_diagnosticSettings",
                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                              },
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                              "properties": {
                                "copy": [
                                  {
                                    "name": "metrics",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                    "input": {
                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                      "timeGrain": null
                                    }
                                  },
                                  {
                                    "name": "logs",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                    "input": {
                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                    }
                                  }
                                ],
                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_roleAssignments": {
                              "copy": {
                                "name": "registry_roleAssignments",
                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]"
                              },
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
                              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId, coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)]",
                              "properties": {
                                "roleDefinitionId": "[if(contains(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName), variables('builtInRoleNames')[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName], if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)))]",
                                "principalId": "[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId]",
                                "description": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'description')]",
                                "principalType": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                "condition": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition')]",
                                "conditionVersion": "[if(not(empty(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_replications": {
                              "copy": {
                                "name": "registry_replications",
                                "count": "[length(coalesce(parameters('replications'), createArray()))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}-Registry-Replication-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[coalesce(parameters('replications'), createArray())[copyIndex()].name]"
                                  },
                                  "registryName": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[coalesce(parameters('replications'), createArray())[copyIndex()].location]"
                                  },
                                  "regionEndpointEnabled": {
                                    "value": "[tryGet(coalesce(parameters('replications'), createArray())[copyIndex()], 'regionEndpointEnabled')]"
                                  },
                                  "zoneRedundancy": {
                                    "value": "[tryGet(coalesce(parameters('replications'), createArray())[copyIndex()], 'zoneRedundancy')]"
                                  },
                                  "tags": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('replications'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.25.53.49325",
                                      "templateHash": "10714256463183699741"
                                    },
                                    "name": "Azure Container Registry (ACR) Replications",
                                    "description": "This module deploys an Azure Container Registry (ACR) Replication.",
                                    "owner": "Azure/module-maintainers"
                                  },
                                  "parameters": {
                                    "registryName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Conditional. The name of the parent registry. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the replication."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all resources."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Tags of the resource."
                                      }
                                    },
                                    "regionEndpointEnabled": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Specifies whether the replication regional endpoint is enabled. Requests will not be routed to a replication whose regional endpoint is disabled, however its data will continue to be synced with other replications."
                                      }
                                    },
                                    "zoneRedundancy": {
                                      "type": "string",
                                      "defaultValue": "Disabled",
                                      "allowedValues": [
                                        "Disabled",
                                        "Enabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Whether or not zone redundancy is enabled for this container registry."
                                      }
                                    }
                                  },
                                  "resources": {
                                    "registry": {
                                      "existing": true,
                                      "type": "Microsoft.ContainerRegistry/registries",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[parameters('registryName')]"
                                    },
                                    "replication": {
                                      "type": "Microsoft.ContainerRegistry/registries/replications",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[format('{0}/{1}', parameters('registryName'), parameters('name'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "regionEndpointEnabled": "[parameters('regionEndpointEnabled')]",
                                        "zoneRedundancy": "[parameters('zoneRedundancy')]"
                                      },
                                      "dependsOn": [
                                        "registry"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the replication."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the replication."
                                      },
                                      "value": "[resourceId('Microsoft.ContainerRegistry/registries/replications', parameters('registryName'), parameters('name'))]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the resource group the replication was created in."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('replication', '2023-06-01-preview', 'full').location]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_cacheRules": {
                              "copy": {
                                "name": "registry_cacheRules",
                                "count": "[length(coalesce(parameters('cacheRules'), createArray()))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}-Registry-Cache-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "registryName": {
                                    "value": "[parameters('name')]"
                                  },
                                  "sourceRepository": {
                                    "value": "[coalesce(parameters('cacheRules'), createArray())[copyIndex()].sourceRepository]"
                                  },
                                  "name": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('cacheRules'), createArray())[copyIndex()], 'name'), replace(replace(coalesce(parameters('cacheRules'), createArray())[copyIndex()].sourceRepository, '/', '-'), '.', '-'))]"
                                  },
                                  "targetRepository": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('cacheRules'), createArray())[copyIndex()], 'targetRepository'), coalesce(parameters('cacheRules'), createArray())[copyIndex()].sourceRepository)]"
                                  },
                                  "credentialSetResourceId": {
                                    "value": "[tryGet(coalesce(parameters('cacheRules'), createArray())[copyIndex()], 'credentialSetResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.25.53.49325",
                                      "templateHash": "6942960102258463312"
                                    },
                                    "name": "Container Registries Cache",
                                    "description": "Cache for Azure Container Registry (Preview) feature allows users to cache container images in a private container registry. Cache for ACR, is a preview feature available in Basic, Standard, and Premium service tiers ([ref](https://learn.microsoft.com/en-us/azure/container-registry/tutorial-registry-cache)).",
                                    "owner": "Azure/module-maintainers"
                                  },
                                  "parameters": {
                                    "registryName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the parent registry. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "name": {
                                      "type": "string",
                                      "defaultValue": "[replace(replace(parameters('sourceRepository'), '/', '-'), '.', '-')]",
                                      "metadata": {
                                        "description": "Optional. The name of the cache rule. Will be dereived from the source repository name if not defined."
                                      }
                                    },
                                    "sourceRepository": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. Source repository pulled from upstream."
                                      }
                                    },
                                    "targetRepository": {
                                      "type": "string",
                                      "defaultValue": "[parameters('sourceRepository')]",
                                      "metadata": {
                                        "description": "Optional. Target repository specified in docker pull command. E.g.: docker pull myregistry.azurecr.io/{targetRepository}:{tag}."
                                      }
                                    },
                                    "credentialSetResourceId": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The resource ID of the credential store which is associated with the cache rule."
                                      }
                                    }
                                  },
                                  "resources": {
                                    "registry": {
                                      "existing": true,
                                      "type": "Microsoft.ContainerRegistry/registries",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[parameters('registryName')]"
                                    },
                                    "cacheRule": {
                                      "type": "Microsoft.ContainerRegistry/registries/cacheRules",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[format('{0}/{1}', parameters('registryName'), parameters('name'))]",
                                      "properties": {
                                        "sourceRepository": "[parameters('sourceRepository')]",
                                        "targetRepository": "[parameters('targetRepository')]",
                                        "credentialSetResourceId": "[parameters('credentialSetResourceId')]"
                                      },
                                      "dependsOn": [
                                        "registry"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The Name of the Cache Rule."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the Cache Rule."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the Cache Rule."
                                      },
                                      "value": "[resourceId('Microsoft.ContainerRegistry/registries/cacheRules', parameters('registryName'), parameters('name'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_webhooks": {
                              "copy": {
                                "name": "registry_webhooks",
                                "count": "[length(coalesce(parameters('webhooks'), createArray()))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}-Registry-Webhook-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[coalesce(parameters('webhooks'), createArray())[copyIndex()].name]"
                                  },
                                  "registryName": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'location'), parameters('location'))]"
                                  },
                                  "action": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'action'), createArray('chart_delete', 'chart_push', 'delete', 'push', 'quarantine'))]"
                                  },
                                  "customHeaders": {
                                    "value": "[tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'customHeaders')]"
                                  },
                                  "scope": {
                                    "value": "[tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'scope')]"
                                  },
                                  "status": {
                                    "value": "[tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'status')]"
                                  },
                                  "serviceUri": {
                                    "value": "[coalesce(parameters('webhooks'), createArray())[copyIndex()].serviceUri]"
                                  },
                                  "tags": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('webhooks'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.25.53.49325",
                                      "templateHash": "3986666280667981658"
                                    },
                                    "name": "Azure Container Registry (ACR) Webhooks",
                                    "description": "This module deploys an Azure Container Registry (ACR) Webhook.",
                                    "owner": "Azure/module-maintainers"
                                  },
                                  "parameters": {
                                    "registryName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Conditional. The name of the parent registry. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "name": {
                                      "type": "string",
                                      "defaultValue": "[format('{0}webhook', parameters('registryName'))]",
                                      "minLength": 5,
                                      "maxLength": 50,
                                      "metadata": {
                                        "description": "Optional. The name of the registry webhook."
                                      }
                                    },
                                    "serviceUri": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The service URI for the webhook to post notifications."
                                      }
                                    },
                                    "status": {
                                      "type": "string",
                                      "defaultValue": "enabled",
                                      "allowedValues": [
                                        "disabled",
                                        "enabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The status of the webhook at the time the operation was called."
                                      }
                                    },
                                    "action": {
                                      "type": "array",
                                      "defaultValue": [
                                        "chart_delete",
                                        "chart_push",
                                        "delete",
                                        "push",
                                        "quarantine"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The list of actions that trigger the webhook to post notifications."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all resources."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Tags of the resource."
                                      }
                                    },
                                    "customHeaders": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Custom headers that will be added to the webhook notifications."
                                      }
                                    },
                                    "scope": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The scope of repositories where the event can be triggered. For example, 'foo:*' means events for all tags under repository 'foo'. 'foo:bar' means events for 'foo:bar' only. 'foo' is equivalent to 'foo:latest'. Empty means all events."
                                      }
                                    }
                                  },
                                  "resources": {
                                    "registry": {
                                      "existing": true,
                                      "type": "Microsoft.ContainerRegistry/registries",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[parameters('registryName')]"
                                    },
                                    "webhook": {
                                      "type": "Microsoft.ContainerRegistry/registries/webhooks",
                                      "apiVersion": "2023-06-01-preview",
                                      "name": "[format('{0}/{1}', parameters('registryName'), parameters('name'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "actions": "[parameters('action')]",
                                        "customHeaders": "[parameters('customHeaders')]",
                                        "scope": "[parameters('scope')]",
                                        "serviceUri": "[parameters('serviceUri')]",
                                        "status": "[parameters('status')]"
                                      },
                                      "dependsOn": [
                                        "registry"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the webhook."
                                      },
                                      "value": "[resourceId('Microsoft.ContainerRegistry/registries/webhooks', parameters('registryName'), parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the webhook."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the Azure container registry."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "actions": {
                                      "type": "array",
                                      "metadata": {
                                        "description": "The actions of the webhook."
                                      },
                                      "value": "[reference('webhook').actions]"
                                    },
                                    "status": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The status of the webhook."
                                      },
                                      "value": "[reference('webhook').status]"
                                    },
                                    "provistioningState": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The provisioning state of the webhook."
                                      },
                                      "value": "[reference('webhook').provisioningState]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('webhook', '2023-06-01-preview', 'full').location]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            },
                            "registry_privateEndpoints": {
                              "copy": {
                                "name": "registry_privateEndpoints",
                                "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}-registry-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "privateLinkServiceConnections": {
                                    "value": [
                                      {
                                        "name": "[parameters('name')]",
                                        "properties": {
                                          "privateLinkServiceId": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]",
                                          "groupIds": [
                                            "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'registry')]"
                                          ]
                                        }
                                      }
                                    ]
                                  },
                                  "name": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'registry'), copyIndex()))]"
                                  },
                                  "subnetResourceId": {
                                    "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                  },
                                  "enableTelemetry": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'enableTelemetry'), parameters('enableTelemetry'))]"
                                  },
                                  "location": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                  },
                                  "lock": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                  },
                                  "privateDnsZoneGroupName": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroupName')]"
                                  },
                                  "privateDnsZoneResourceIds": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneResourceIds')]"
                                  },
                                  "roleAssignments": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                  },
                                  "tags": {
                                    "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                  },
                                  "manualPrivateLinkServiceConnections": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualPrivateLinkServiceConnections')]"
                                  },
                                  "customDnsConfigs": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                  },
                                  "ipConfigurations": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                  },
                                  "applicationSecurityGroupResourceIds": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                  },
                                  "customNetworkInterfaceName": {
                                    "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.23.1.45101",
                                      "templateHash": "2821141217598568122"
                                    },
                                    "name": "Private Endpoints",
                                    "description": "This module deploys a Private Endpoint.",
                                    "owner": "Azure/module-maintainers"
                                  },
                                  "definitions": {
                                    "roleAssignmentType": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "roleDefinitionIdOrName": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                            }
                                          },
                                          "principalId": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                            }
                                          },
                                          "principalType": {
                                            "type": "string",
                                            "allowedValues": [
                                              "Device",
                                              "ForeignGroup",
                                              "Group",
                                              "ServicePrincipal",
                                              "User"
                                            ],
                                            "nullable": true,
                                            "metadata": {
                                              "description": "Optional. The principal type of the assigned principal ID."
                                            }
                                          },
                                          "description": {
                                            "type": "string",
                                            "nullable": true,
                                            "metadata": {
                                              "description": "Optional. The description of the role assignment."
                                            }
                                          },
                                          "condition": {
                                            "type": "string",
                                            "nullable": true,
                                            "metadata": {
                                              "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\""
                                            }
                                          },
                                          "conditionVersion": {
                                            "type": "string",
                                            "allowedValues": [
                                              "2.0"
                                            ],
                                            "nullable": true,
                                            "metadata": {
                                              "description": "Optional. Version of the condition."
                                            }
                                          },
                                          "delegatedManagedIdentityResourceId": {
                                            "type": "string",
                                            "nullable": true,
                                            "metadata": {
                                              "description": "Optional. The Resource Id of the delegated managed identity resource."
                                            }
                                          }
                                        }
                                      },
                                      "nullable": true
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        }
                                      },
                                      "nullable": true
                                    },
                                    "ipConfigurationsType": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "name": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. The name of the resource that is unique within a resource group."
                                            }
                                          },
                                          "properties": {
                                            "type": "object",
                                            "properties": {
                                              "groupId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                                }
                                              },
                                              "memberName": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                                }
                                              },
                                              "privateIPAddress": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                                }
                                              }
                                            },
                                            "metadata": {
                                              "description": "Required. Properties of private endpoint IP configurations."
                                            }
                                          }
                                        }
                                      },
                                      "nullable": true
                                    },
                                    "manualPrivateLinkServiceConnectionsType": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "name": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. The name of the private link service connection."
                                            }
                                          },
                                          "properties": {
                                            "type": "object",
                                            "properties": {
                                              "groupIds": {
                                                "type": "array",
                                                "metadata": {
                                                  "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                                }
                                              },
                                              "privateLinkServiceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of private link service."
                                                }
                                              },
                                              "requestMessage": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Optional. A message passed to the owner of the remote resource with this connection request. Restricted to 140 chars."
                                                }
                                              }
                                            },
                                            "metadata": {
                                              "description": "Required. Properties of private link service connection."
                                            }
                                          }
                                        }
                                      },
                                      "nullable": true
                                    },
                                    "privateLinkServiceConnectionsType": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "name": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. The name of the private link service connection."
                                            }
                                          },
                                          "properties": {
                                            "type": "object",
                                            "properties": {
                                              "groupIds": {
                                                "type": "array",
                                                "metadata": {
                                                  "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                                }
                                              },
                                              "privateLinkServiceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of private link service."
                                                }
                                              },
                                              "requestMessage": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. A message passed to the owner of the remote resource with this connection request. Restricted to 140 chars."
                                                }
                                              }
                                            },
                                            "metadata": {
                                              "description": "Required. Properties of private link service connection."
                                            }
                                          }
                                        }
                                      },
                                      "nullable": true
                                    },
                                    "customDnsConfigType": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "fqdn": {
                                            "type": "string",
                                            "metadata": {
                                              "description": "Required. Fqdn that resolves to private endpoint IP address."
                                            }
                                          },
                                          "ipAddresses": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "metadata": {
                                              "description": "Required. A list of private IP addresses of the private endpoint."
                                            }
                                          }
                                        }
                                      },
                                      "nullable": true
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. Name of the private endpoint resource to create."
                                      }
                                    },
                                    "subnetResourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                      }
                                    },
                                    "applicationSecurityGroupResourceIds": {
                                      "type": "array",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                      }
                                    },
                                    "customNetworkInterfaceName": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                      }
                                    },
                                    "ipConfigurations": {
                                      "$ref": "#/definitions/ipConfigurationsType",
                                      "metadata": {
                                        "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                      }
                                    },
                                    "privateDnsZoneGroupName": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The name of the private DNS zone group to create if `privateDnsZoneResourceIds` were provided."
                                      }
                                    },
                                    "privateDnsZoneResourceIds": {
                                      "type": "array",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all Resources."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "metadata": {
                                        "description": "Optional. The lock settings of the service."
                                      }
                                    },
                                    "roleAssignments": {
                                      "$ref": "#/definitions/roleAssignmentType",
                                      "metadata": {
                                        "description": "Optional. Array of role assignments to create."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                      }
                                    },
                                    "customDnsConfigs": {
                                      "$ref": "#/definitions/customDnsConfigType",
                                      "metadata": {
                                        "description": "Optional. Custom DNS configurations."
                                      }
                                    },
                                    "manualPrivateLinkServiceConnections": {
                                      "$ref": "#/definitions/manualPrivateLinkServiceConnectionsType",
                                      "metadata": {
                                        "description": "Optional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource."
                                      }
                                    },
                                    "privateLinkServiceConnections": {
                                      "$ref": "#/definitions/privateLinkServiceConnectionsType",
                                      "metadata": {
                                        "description": "Optional. A grouping of information about the connection to the remote resource."
                                      }
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "builtInRoleNames": {
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                      "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                      "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                      "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                      "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Role Based Access Control Administrator (Preview)": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                    }
                                  },
                                  "resources": {
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2023-07-01",
                                      "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.3.2', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "privateEndpoint": {
                                      "type": "Microsoft.Network/privateEndpoints",
                                      "apiVersion": "2023-04-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "applicationSecurityGroups",
                                            "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                            "input": {
                                              "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                            }
                                          }
                                        ],
                                        "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                        "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                        "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                        "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                        "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                        "subnet": {
                                          "id": "[parameters('subnetResourceId')]"
                                        }
                                      }
                                    },
                                    "privateEndpoint_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
                                      },
                                      "dependsOn": [
                                        "privateEndpoint"
                                      ]
                                    },
                                    "privateEndpoint_roleAssignments": {
                                      "copy": {
                                        "name": "privateEndpoint_roleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                      "name": "[guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId, coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)]",
                                      "properties": {
                                        "roleDefinitionId": "[if(contains(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName), variables('builtInRoleNames')[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName], if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)))]",
                                        "principalId": "[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "privateEndpoint"
                                      ]
                                    },
                                    "privateEndpoint_privateDnsZoneGroup": {
                                      "condition": "[not(empty(parameters('privateDnsZoneResourceIds')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(parameters('privateDnsZoneGroupName'), 'default')]"
                                          },
                                          "privateDNSResourceIds": {
                                            "value": "[coalesce(parameters('privateDnsZoneResourceIds'), createArray())]"
                                          },
                                          "privateEndpointName": {
                                            "value": "[parameters('name')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.23.1.45101",
                                              "templateHash": "18168683629401652671"
                                            },
                                            "name": "Private Endpoint Private DNS Zone Groups",
                                            "description": "This module deploys a Private Endpoint Private DNS Zone Group.",
                                            "owner": "Azure/module-maintainers"
                                          },
                                          "parameters": {
                                            "privateEndpointName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "privateDNSResourceIds": {
                                              "type": "array",
                                              "minLength": 1,
                                              "maxLength": 5,
                                              "metadata": {
                                                "description": "Required. Array of private DNS zone resource IDs. A DNS zone group can support up to 5 DNS zones."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "defaultValue": "default",
                                              "metadata": {
                                                "description": "Optional. The name of the private DNS zone group."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "privateDnsZoneConfigs",
                                                "count": "[length(parameters('privateDNSResourceIds'))]",
                                                "input": {
                                                  "name": "[last(split(parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                                                  "properties": {
                                                    "privateDnsZoneId": "[parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')]]"
                                                  }
                                                }
                                              }
                                            ]
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                              "apiVersion": "2023-04-01",
                                              "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                              "properties": {
                                                "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigs')]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint DNS zone group."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint DNS zone group."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint DNS zone group was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "privateEndpoint"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource group the private endpoint was deployed into."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the private endpoint."
                                      },
                                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the private endpoint."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('privateEndpoint', '2023-04-01', 'full').location]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "registry"
                              ]
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The Name of the Azure container registry."
                              },
                              "value": "[parameters('name')]"
                            },
                            "loginServer": {
                              "type": "string",
                              "metadata": {
                                "description": "The reference to the Azure container registry."
                              },
                              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2019-05-01').loginServer]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the Azure container registry."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the Azure container registry."
                              },
                              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
                            },
                            "systemAssignedMIPrincipalId": {
                              "type": "string",
                              "metadata": {
                                "description": "The principal ID of the system assigned identity."
                              },
                              "value": "[coalesce(tryGet(tryGet(reference('registry', '2023-06-01-preview', 'full'), 'identity'), 'principalId'), '')]"
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "The location the resource was deployed into."
                              },
                              "value": "[reference('registry', '2023-06-01-preview', 'full').location]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "acr-connection-creation",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "aiServicesAccountName": {
                            "value": "[parameters('aiServicesAccountName')]"
                          },
                          "aiProjectName": {
                            "value": "[parameters('aiProjectName')]"
                          },
                          "connectionConfig": {
                            "value": {
                              "name": "[parameters('connectionName')]",
                              "category": "ContainerRegistry",
                              "target": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.loginServer.value]",
                              "authType": "ManagedIdentity",
                              "credentials": {
                                "clientId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                                "resourceId": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.resourceId.value]"
                              },
                              "isSharedToAll": true,
                              "metadata": {
                                "ResourceId": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.resourceId.value]"
                              }
                            }
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16558283348227387412"
                            }
                          },
                          "definitions": {
                            "ConnectionConfig": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Name of the connection"
                                  }
                                },
                                "category": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                                  }
                                },
                                "target": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Target endpoint or URL for the connection"
                                  }
                                },
                                "authType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AAD",
                                    "AccessKey",
                                    "AccountKey",
                                    "ApiKey",
                                    "CustomKeys",
                                    "ManagedIdentity",
                                    "None",
                                    "OAuth2",
                                    "PAT",
                                    "SAS",
                                    "ServicePrincipal",
                                    "UsernamePassword"
                                  ],
                                  "metadata": {
                                    "description": "Authentication type"
                                  }
                                },
                                "isSharedToAll": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Whether the connection is shared to all users (optional, defaults to true)"
                                  }
                                },
                                "credentials": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Credentials for non-ApiKey authentication types (optional)"
                                  }
                                },
                                "metadata": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Additional metadata for the connection (optional)"
                                  }
                                }
                              }
                            }
                          },
                          "parameters": {
                            "aiServicesAccountName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI Services account name"
                              }
                            },
                            "aiProjectName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI project name"
                              }
                            },
                            "connectionConfig": {
                              "$ref": "#/definitions/ConnectionConfig",
                              "metadata": {
                                "description": "Connection configuration"
                              }
                            },
                            "apiKey": {
                              "type": "securestring",
                              "defaultValue": "",
                              "metadata": {
                                "description": "API key for ApiKey based connections (optional)"
                              }
                            }
                          },
                          "resources": {
                            "aiAccount::project": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                            },
                            "aiAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[parameters('aiServicesAccountName')]"
                            },
                            "connection": {
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                              "properties": {
                                "category": "[parameters('connectionConfig').category]",
                                "target": "[parameters('connectionConfig').target]",
                                "authType": "[parameters('connectionConfig').authType]",
                                "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                                "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                                "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                              }
                            }
                          },
                          "outputs": {
                            "connectionName": {
                              "type": "string",
                              "value": "[parameters('connectionConfig').name]"
                            },
                            "connectionId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', 'registry')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "containerRegistryName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.name.value]"
                    },
                    "containerRegistryLoginServer": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.loginServer.value]"
                    },
                    "containerRegistryResourceId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'registry'), '2025-04-01').outputs.resourceId.value]"
                    },
                    "containerRegistryConnectionName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr-connection-creation'), '2025-04-01').outputs.connectionName.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "bingGrounding": {
              "condition": "[variables('hasBingConnection')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "bing-grounding",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "resourceName": {
                    "value": "[format('bing-{0}', variables('resourceToken'))]"
                  },
                  "connectionName": {
                    "value": "[variables('bingConnectionName')]"
                  },
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "16745311920918165260"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags that will be applied to all resources"
                      }
                    },
                    "resourceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Bing grounding resource name"
                      }
                    },
                    "aiServicesAccountName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI Services account name for the project parent"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI project name for creating the connection"
                      }
                    },
                    "connectionName": {
                      "type": "string",
                      "defaultValue": "bing-grounding-connection",
                      "metadata": {
                        "description": "Name for the AI Foundry Bing Search connection"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Bing/accounts",
                      "apiVersion": "2020-06-10",
                      "name": "[parameters('resourceName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "G1"
                      },
                      "properties": {
                        "statisticsEnabled": false
                      },
                      "kind": "Bing.Grounding"
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Bing/accounts/{0}', parameters('resourceName'))]",
                      "name": "[guid(subscription().id, resourceGroup().id, 'bing-search-role', parameters('aiServicesAccountName'), parameters('aiProjectName'))]",
                      "properties": {
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "bing-search-connection-creation",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "aiServicesAccountName": {
                            "value": "[parameters('aiServicesAccountName')]"
                          },
                          "aiProjectName": {
                            "value": "[parameters('aiProjectName')]"
                          },
                          "connectionConfig": {
                            "value": {
                              "name": "[parameters('connectionName')]",
                              "category": "GroundingWithBingSearch",
                              "target": "[reference(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), '2020-06-10').endpoint]",
                              "authType": "ApiKey",
                              "isSharedToAll": true,
                              "metadata": {
                                "Location": "global",
                                "ResourceId": "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]",
                                "ApiType": "Azure",
                                "type": "bing_grounding"
                              }
                            }
                          },
                          "apiKey": {
                            "value": "[listKeys(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), '2020-06-10').key1]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16558283348227387412"
                            }
                          },
                          "definitions": {
                            "ConnectionConfig": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Name of the connection"
                                  }
                                },
                                "category": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                                  }
                                },
                                "target": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Target endpoint or URL for the connection"
                                  }
                                },
                                "authType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AAD",
                                    "AccessKey",
                                    "AccountKey",
                                    "ApiKey",
                                    "CustomKeys",
                                    "ManagedIdentity",
                                    "None",
                                    "OAuth2",
                                    "PAT",
                                    "SAS",
                                    "ServicePrincipal",
                                    "UsernamePassword"
                                  ],
                                  "metadata": {
                                    "description": "Authentication type"
                                  }
                                },
                                "isSharedToAll": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Whether the connection is shared to all users (optional, defaults to true)"
                                  }
                                },
                                "credentials": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Credentials for non-ApiKey authentication types (optional)"
                                  }
                                },
                                "metadata": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Additional metadata for the connection (optional)"
                                  }
                                }
                              }
                            }
                          },
                          "parameters": {
                            "aiServicesAccountName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI Services account name"
                              }
                            },
                            "aiProjectName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI project name"
                              }
                            },
                            "connectionConfig": {
                              "$ref": "#/definitions/ConnectionConfig",
                              "metadata": {
                                "description": "Connection configuration"
                              }
                            },
                            "apiKey": {
                              "type": "securestring",
                              "defaultValue": "",
                              "metadata": {
                                "description": "API key for ApiKey based connections (optional)"
                              }
                            }
                          },
                          "resources": {
                            "aiAccount::project": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                            },
                            "aiAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[parameters('aiServicesAccountName')]"
                            },
                            "connection": {
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                              "properties": {
                                "category": "[parameters('connectionConfig').category]",
                                "target": "[parameters('connectionConfig').target]",
                                "authType": "[parameters('connectionConfig').authType]",
                                "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                                "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                                "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                              }
                            }
                          },
                          "outputs": {
                            "connectionName": {
                              "type": "string",
                              "value": "[parameters('connectionConfig').name]"
                            },
                            "connectionId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]",
                        "[extensionResourceId(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), 'Microsoft.Authorization/roleAssignments', guid(subscription().id, resourceGroup().id, 'bing-search-role', parameters('aiServicesAccountName'), parameters('aiProjectName')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "bingGroundingName": {
                      "type": "string",
                      "value": "[parameters('resourceName')]"
                    },
                    "bingGroundingConnectionName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'bing-search-connection-creation'), '2025-04-01').outputs.connectionName.value]"
                    },
                    "bingGroundingResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]"
                    },
                    "bingGroundingConnectionId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'bing-search-connection-creation'), '2025-04-01').outputs.connectionId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "bingCustomGrounding": {
              "condition": "[variables('hasBingCustomConnection')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "bing-custom-grounding",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "resourceName": {
                    "value": "[format('bingcustom-{0}', variables('resourceToken'))]"
                  },
                  "connectionName": {
                    "value": "[variables('bingCustomConnectionName')]"
                  },
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "8652904484193898735"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags that will be applied to all resources"
                      }
                    },
                    "resourceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Bing custom grounding resource name"
                      }
                    },
                    "aiServicesAccountName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI Services account name for the project parent"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI project name for creating the connection"
                      }
                    },
                    "connectionName": {
                      "type": "string",
                      "defaultValue": "bing-custom-grounding-connection",
                      "metadata": {
                        "description": "Name for the AI Foundry Bing Custom Search connection"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Bing/accounts",
                      "apiVersion": "2020-06-10",
                      "name": "[parameters('resourceName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "G1"
                      },
                      "properties": {
                        "statisticsEnabled": false
                      },
                      "kind": "Bing.CustomGrounding"
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Bing/accounts/{0}', parameters('resourceName'))]",
                      "name": "[guid(subscription().id, resourceGroup().id, 'bing-search-role', parameters('aiServicesAccountName'), parameters('aiProjectName'))]",
                      "properties": {
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "bing-custom-search-connection-creation",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "aiServicesAccountName": {
                            "value": "[parameters('aiServicesAccountName')]"
                          },
                          "aiProjectName": {
                            "value": "[parameters('aiProjectName')]"
                          },
                          "connectionConfig": {
                            "value": {
                              "name": "[parameters('connectionName')]",
                              "category": "GroundingWithCustomSearch",
                              "target": "[reference(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), '2020-06-10').endpoint]",
                              "authType": "ApiKey",
                              "isSharedToAll": true,
                              "metadata": {
                                "Location": "global",
                                "ResourceId": "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]",
                                "ApiType": "Azure",
                                "type": "bing_custom_search"
                              }
                            }
                          },
                          "apiKey": {
                            "value": "[listKeys(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), '2020-06-10').key1]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16558283348227387412"
                            }
                          },
                          "definitions": {
                            "ConnectionConfig": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Name of the connection"
                                  }
                                },
                                "category": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                                  }
                                },
                                "target": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Target endpoint or URL for the connection"
                                  }
                                },
                                "authType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AAD",
                                    "AccessKey",
                                    "AccountKey",
                                    "ApiKey",
                                    "CustomKeys",
                                    "ManagedIdentity",
                                    "None",
                                    "OAuth2",
                                    "PAT",
                                    "SAS",
                                    "ServicePrincipal",
                                    "UsernamePassword"
                                  ],
                                  "metadata": {
                                    "description": "Authentication type"
                                  }
                                },
                                "isSharedToAll": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Whether the connection is shared to all users (optional, defaults to true)"
                                  }
                                },
                                "credentials": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Credentials for non-ApiKey authentication types (optional)"
                                  }
                                },
                                "metadata": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Additional metadata for the connection (optional)"
                                  }
                                }
                              }
                            }
                          },
                          "parameters": {
                            "aiServicesAccountName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI Services account name"
                              }
                            },
                            "aiProjectName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI project name"
                              }
                            },
                            "connectionConfig": {
                              "$ref": "#/definitions/ConnectionConfig",
                              "metadata": {
                                "description": "Connection configuration"
                              }
                            },
                            "apiKey": {
                              "type": "securestring",
                              "defaultValue": "",
                              "metadata": {
                                "description": "API key for ApiKey based connections (optional)"
                              }
                            }
                          },
                          "resources": {
                            "aiAccount::project": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                            },
                            "aiAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[parameters('aiServicesAccountName')]"
                            },
                            "connection": {
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                              "properties": {
                                "category": "[parameters('connectionConfig').category]",
                                "target": "[parameters('connectionConfig').target]",
                                "authType": "[parameters('connectionConfig').authType]",
                                "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                                "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                                "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                              }
                            }
                          },
                          "outputs": {
                            "connectionName": {
                              "type": "string",
                              "value": "[parameters('connectionConfig').name]"
                            },
                            "connectionId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]",
                        "[extensionResourceId(resourceId('Microsoft.Bing/accounts', parameters('resourceName')), 'Microsoft.Authorization/roleAssignments', guid(subscription().id, resourceGroup().id, 'bing-search-role', parameters('aiServicesAccountName'), parameters('aiProjectName')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "bingCustomGroundingName": {
                      "type": "string",
                      "value": "[parameters('resourceName')]"
                    },
                    "bingCustomGroundingConnectionName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'bing-custom-search-connection-creation'), '2025-04-01').outputs.connectionName.value]"
                    },
                    "bingCustomGroundingResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Bing/accounts', parameters('resourceName'))]"
                    },
                    "bingCustomGroundingConnectionId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'bing-custom-search-connection-creation'), '2025-04-01').outputs.connectionId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project"
              ]
            },
            "azureAiSearch": {
              "condition": "[variables('hasSearchConnection')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "azure-ai-search",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "resourceName": {
                    "value": "[format('search-{0}', variables('resourceToken'))]"
                  },
                  "connectionName": {
                    "value": "[variables('searchConnectionName')]"
                  },
                  "storageAccountResourceId": "[if(variables('hasStorageConnection'), createObject('value', reference('storage').outputs.storageAccountId.value), createObject('value', ''))]",
                  "containerName": {
                    "value": "knowledge"
                  },
                  "aiServicesAccountName": {
                    "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiFoundryProjectName')]"
                  },
                  "principalId": {
                    "value": "[parameters('principalId')]"
                  },
                  "principalType": {
                    "value": "[parameters('principalType')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "10218830849073290470"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags that will be applied to all resources"
                      }
                    },
                    "resourceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure Search resource name"
                      }
                    },
                    "azureSearchSkuName": {
                      "type": "string",
                      "defaultValue": "basic",
                      "metadata": {
                        "description": "Azure Search SKU name"
                      }
                    },
                    "storageAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure storage account resource ID"
                      }
                    },
                    "containerName": {
                      "type": "string",
                      "defaultValue": "knowledgebase",
                      "metadata": {
                        "description": "container name"
                      }
                    },
                    "aiServicesAccountName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI Services account name for the project parent"
                      }
                    },
                    "aiProjectName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "AI project name for creating the connection"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Id of the user or app to assign application roles"
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal type of user or app"
                      }
                    },
                    "connectionName": {
                      "type": "string",
                      "defaultValue": "azure-ai-search-connection",
                      "metadata": {
                        "description": "Name for the AI Foundry search connection"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for all resources"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Search/searchServices",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[parameters('resourceName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('azureSearchSkuName')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "replicaCount": 1,
                        "partitionCount": 1,
                        "hostingMode": "default",
                        "authOptions": {
                          "aadOrApiKey": {
                            "aadAuthFailureMode": "http401WithBearerChallenge"
                          }
                        },
                        "disableLocalAuth": false,
                        "encryptionWithCmk": {
                          "enforcement": "Unspecified"
                        },
                        "publicNetworkAccess": "enabled"
                      }
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}/{2}', last(split(parameters('storageAccountResourceId'), '/')), 'default', parameters('containerName'))]",
                      "properties": {
                        "publicAccess": "None"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountResourceId'), '/')))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), resourceId('Microsoft.Search/searchServices', parameters('resourceName')), 'Storage Blob Data Reader', uniqueString(deployment().name))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                        "principalId": "[reference(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), '2024-06-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('aiServicesAccountName')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('aiServicesAccountName'), resourceId('Microsoft.Search/searchServices', parameters('resourceName')), 'Cognitive Services OpenAI User', uniqueString(deployment().name))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                        "principalId": "[reference(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), '2024-06-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('resourceName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), parameters('aiServicesAccountName'), parameters('aiProjectName'), 'Search Service Contributor', uniqueString(deployment().name))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('resourceName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), parameters('aiServicesAccountName'), parameters('aiProjectName'), 'Search Index Data Contributor', uniqueString(deployment().name))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServicesAccountName'), parameters('aiProjectName')), '2025-04-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('resourceName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), parameters('principalId'), 'Search Index Data Contributor', uniqueString(deployment().name))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "[parameters('principalType')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    },
                    {
                      "condition": "[and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "ai-search-connection-creation",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "aiServicesAccountName": {
                            "value": "[parameters('aiServicesAccountName')]"
                          },
                          "aiProjectName": {
                            "value": "[parameters('aiProjectName')]"
                          },
                          "connectionConfig": {
                            "value": {
                              "name": "[parameters('connectionName')]",
                              "category": "CognitiveSearch",
                              "target": "[format('https://{0}.search.windows.net', parameters('resourceName'))]",
                              "authType": "AAD",
                              "isSharedToAll": true,
                              "metadata": {
                                "ApiVersion": "2024-07-01",
                                "ResourceId": "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]",
                                "ApiType": "Azure",
                                "type": "azure_ai_search"
                              }
                            }
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16558283348227387412"
                            }
                          },
                          "definitions": {
                            "ConnectionConfig": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Name of the connection"
                                  }
                                },
                                "category": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Category of the connection (e.g., ContainerRegistry, AzureStorageAccount, CognitiveSearch)"
                                  }
                                },
                                "target": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Target endpoint or URL for the connection"
                                  }
                                },
                                "authType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AAD",
                                    "AccessKey",
                                    "AccountKey",
                                    "ApiKey",
                                    "CustomKeys",
                                    "ManagedIdentity",
                                    "None",
                                    "OAuth2",
                                    "PAT",
                                    "SAS",
                                    "ServicePrincipal",
                                    "UsernamePassword"
                                  ],
                                  "metadata": {
                                    "description": "Authentication type"
                                  }
                                },
                                "isSharedToAll": {
                                  "type": "bool",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Whether the connection is shared to all users (optional, defaults to true)"
                                  }
                                },
                                "credentials": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Credentials for non-ApiKey authentication types (optional)"
                                  }
                                },
                                "metadata": {
                                  "type": "object",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Additional metadata for the connection (optional)"
                                  }
                                }
                              }
                            }
                          },
                          "parameters": {
                            "aiServicesAccountName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI Services account name"
                              }
                            },
                            "aiProjectName": {
                              "type": "string",
                              "metadata": {
                                "description": "AI project name"
                              }
                            },
                            "connectionConfig": {
                              "$ref": "#/definitions/ConnectionConfig",
                              "metadata": {
                                "description": "Connection configuration"
                              }
                            },
                            "apiKey": {
                              "type": "securestring",
                              "defaultValue": "",
                              "metadata": {
                                "description": "API key for ApiKey based connections (optional)"
                              }
                            }
                          },
                          "resources": {
                            "aiAccount::project": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}', parameters('aiServicesAccountName'), parameters('aiProjectName'))]"
                            },
                            "aiAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[parameters('aiServicesAccountName')]"
                            },
                            "connection": {
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-04-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]",
                              "properties": {
                                "category": "[parameters('connectionConfig').category]",
                                "target": "[parameters('connectionConfig').target]",
                                "authType": "[parameters('connectionConfig').authType]",
                                "isSharedToAll": "[coalesce(tryGet(parameters('connectionConfig'), 'isSharedToAll'), true())]",
                                "credentials": "[if(equals(parameters('connectionConfig').authType, 'ApiKey'), createObject('key', parameters('apiKey')), tryGet(parameters('connectionConfig'), 'credentials'))]",
                                "metadata": "[tryGet(parameters('connectionConfig'), 'metadata')]"
                              }
                            }
                          },
                          "outputs": {
                            "connectionName": {
                              "type": "string",
                              "value": "[parameters('connectionConfig').name]"
                            },
                            "connectionId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiServicesAccountName'), parameters('aiProjectName'), parameters('connectionConfig').name)]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), parameters('aiServicesAccountName'), parameters('aiProjectName'), 'Search Index Data Contributor', uniqueString(deployment().name)))]",
                        "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "searchServiceName": {
                      "type": "string",
                      "value": "[parameters('resourceName')]"
                    },
                    "searchServiceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Search/searchServices', parameters('resourceName'))]"
                    },
                    "searchServicePrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('resourceName')), '2024-06-01-preview', 'full').identity.principalId]"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "value": "[last(split(parameters('storageAccountResourceId'), '/'))]"
                    },
                    "storageAccountId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/')))]"
                    },
                    "containerName": {
                      "type": "string",
                      "value": "[parameters('containerName')]"
                    },
                    "storageAccountPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), '2023-05-01', 'full').identity.principalId]"
                    },
                    "searchConnectionName": {
                      "type": "string",
                      "value": "[if(and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName')))), reference(resourceId('Microsoft.Resources/deployments', 'ai-search-connection-creation'), '2025-04-01').outputs.connectionName.value, '')]"
                    },
                    "searchConnectionId": {
                      "type": "string",
                      "value": "[if(and(not(empty(parameters('aiServicesAccountName'))), not(empty(parameters('aiProjectName')))), reference(resourceId('Microsoft.Resources/deployments', 'ai-search-connection-creation'), '2025-04-01').outputs.connectionId.value, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount",
                "aiAccount::project",
                "storage"
              ]
            }
          },
          "outputs": {
            "AZURE_AI_PROJECT_ENDPOINT": {
              "type": "string",
              "value": "[reference('aiAccount::project').endpoints['AI Foundry API']]"
            },
            "AZURE_OPENAI_ENDPOINT": {
              "type": "string",
              "value": "[reference('aiAccount').endpoints['OpenAI Language Model Instance API']]"
            },
            "aiServicesEndpoint": {
              "type": "string",
              "value": "[reference('aiAccount').endpoint]"
            },
            "accountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))))]"
            },
            "projectId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken'))), parameters('aiFoundryProjectName'))]"
            },
            "aiServicesAccountName": {
              "type": "string",
              "value": "[if(not(empty(parameters('existingAiAccountName'))), parameters('existingAiAccountName'), format('ai-account-{0}', variables('resourceToken')))]"
            },
            "aiServicesProjectName": {
              "type": "string",
              "value": "[parameters('aiFoundryProjectName')]"
            },
            "aiServicesPrincipalId": {
              "type": "string",
              "value": "[reference('aiAccount', '2025-06-01', 'full').identity.principalId]"
            },
            "projectName": {
              "type": "string",
              "value": "[parameters('aiFoundryProjectName')]"
            },
            "APPLICATIONINSIGHTS_CONNECTION_STRING": {
              "type": "string",
              "value": "[reference('applicationInsights').outputs.connectionString.value]"
            },
            "dependentResources": {
              "type": "object",
              "value": {
                "registry": {
                  "name": "[if(variables('hasAcrConnection'), reference('acr').outputs.containerRegistryName.value, '')]",
                  "loginServer": "[if(variables('hasAcrConnection'), reference('acr').outputs.containerRegistryLoginServer.value, '')]",
                  "connectionName": "[if(variables('hasAcrConnection'), reference('acr').outputs.containerRegistryConnectionName.value, '')]"
                },
                "bing_grounding": {
                  "name": "[if(variables('hasBingConnection'), reference('bingGrounding').outputs.bingGroundingName.value, '')]",
                  "connectionName": "[if(variables('hasBingConnection'), reference('bingGrounding').outputs.bingGroundingConnectionName.value, '')]",
                  "connectionId": "[if(variables('hasBingConnection'), reference('bingGrounding').outputs.bingGroundingConnectionId.value, '')]"
                },
                "bing_custom_grounding": {
                  "name": "[if(variables('hasBingCustomConnection'), reference('bingCustomGrounding').outputs.bingCustomGroundingName.value, '')]",
                  "connectionName": "[if(variables('hasBingCustomConnection'), reference('bingCustomGrounding').outputs.bingCustomGroundingConnectionName.value, '')]",
                  "connectionId": "[if(variables('hasBingCustomConnection'), reference('bingCustomGrounding').outputs.bingCustomGroundingConnectionId.value, '')]"
                },
                "search": {
                  "serviceName": "[if(variables('hasSearchConnection'), reference('azureAiSearch').outputs.searchServiceName.value, '')]",
                  "connectionName": "[if(variables('hasSearchConnection'), reference('azureAiSearch').outputs.searchConnectionName.value, '')]"
                },
                "storage": {
                  "accountName": "[if(variables('hasStorageConnection'), reference('storage').outputs.storageAccountName.value, '')]",
                  "connectionName": "[if(variables('hasStorageConnection'), reference('storage').outputs.storageConnectionName.value, '')]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps-identity",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('id-{0}', parameters('environmentName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3259751725644628947"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the user assigned managed identity"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the identity"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps-environment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').appManagedEnvironments, variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6287054113669586655"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the Log Analytics workspace for diagnostics"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": "[if(not(empty(parameters('logAnalyticsWorkspaceId'))), createObject('destination', 'log-analytics', 'logAnalyticsConfiguration', createObject('customerId', reference(parameters('logAnalyticsWorkspaceId'), '2022-10-01').customerId, 'sharedKey', listKeys(parameters('logAnalyticsWorkspaceId'), '2022-10-01').primarySharedKey)), null())]"
              }
            }
          ],
          "outputs": {
            "defaultDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').defaultDomain]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "frontend-container-app",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}frontend-{1}', variables('abbrs').appContainerApps, variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'frontend'))]"
          },
          "containerAppsEnvironmentName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.name.value]"
          },
          "containerRegistryName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.registry.name]"
          },
          "identityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.name.value]"
          },
          "containerName": {
            "value": "frontend"
          },
          "imageName": {
            "value": "[parameters('frontendImageName')]"
          },
          "targetPort": "[if(not(empty(parameters('frontendImageName'))), createObject('value', 3000), createObject('value', 80))]",
          "external": {
            "value": true
          },
          "ingressEnabled": {
            "value": true
          },
          "containerCpuCoreCount": {
            "value": "0.5"
          },
          "containerMemory": {
            "value": "1.0Gi"
          },
          "containerMinReplicas": {
            "value": 1
          },
          "containerMaxReplicas": {
            "value": 3
          },
          "env": {
            "value": [
              {
                "name": "BACKEND_API_URL",
                "value": "[format('https://{0}backend-{1}.{2}', variables('abbrs').appContainerApps, variables('resourceToken'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.defaultDomain.value)]"
              },
              {
                "name": "NODE_ENV",
                "value": "production"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17653866244688030665"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "containerAppsEnvironmentName": {
              "type": "string"
            },
            "containerName": {
              "type": "string",
              "defaultValue": "main"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "containerMinReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "metadata": {
                "description": "Minimum number of replicas to run"
              }
            },
            "containerMaxReplicas": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "metadata": {
                "description": "Maximum number of replicas to run"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": []
            },
            "env": {
              "type": "array",
              "defaultValue": []
            },
            "external": {
              "type": "bool",
              "defaultValue": true
            },
            "imageName": {
              "type": "string"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "User assigned identity name"
              }
            },
            "ingressEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled Ingress for container app"
              }
            },
            "daprEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Dapr"
              }
            },
            "daprAppId": {
              "type": "string",
              "defaultValue": "[parameters('containerName')]",
              "metadata": {
                "description": "Dapr app ID"
              }
            },
            "daprAppProtocol": {
              "type": "string",
              "defaultValue": "http",
              "allowedValues": [
                "http",
                "grpc"
              ],
              "metadata": {
                "description": "Protocol used by Dapr to connect to the app, e.g. http or grpc"
              }
            },
            "containerCpuCoreCount": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU cores allocated to a single container instance, e.g. 0.5"
              }
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "1.0Gi",
              "metadata": {
                "description": "Memory allocated to a single container instance, e.g. 1Gi"
              }
            },
            "authEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable authentication"
              }
            },
            "authAppId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication App ID (client ID)"
              }
            },
            "authIssuerUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication Issuer URL"
              }
            },
            "authAllowedAudiences": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed token audiences"
              }
            },
            "authRequireClientApp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Require client application (true) or allow requests only from this application itself (false)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]",
                "configuration": {
                  "activeRevisionsMode": "multiple",
                  "ingress": "[if(parameters('ingressEnabled'), createObject('external', parameters('external'), 'targetPort', parameters('targetPort'), 'transport', 'auto'), null())]",
                  "dapr": "[if(parameters('daprEnabled'), createObject('enabled', true(), 'appId', parameters('daprAppId'), 'appProtocol', parameters('daprAppProtocol'), 'appPort', if(parameters('ingressEnabled'), parameters('targetPort'), 0)), createObject('enabled', false()))]",
                  "secrets": "[parameters('secrets')]",
                  "registries": [
                    {
                      "server": "[format('{0}.azurecr.io', parameters('containerRegistryName'))]",
                      "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[if(not(empty(parameters('imageName'))), parameters('imageName'), 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest')]",
                      "name": "[parameters('containerName')]",
                      "env": "[parameters('env')]",
                      "resources": {
                        "cpu": "[json(parameters('containerCpuCoreCount'))]",
                        "memory": "[parameters('containerMemory')]"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('containerMinReplicas')]",
                    "maxReplicas": "[parameters('containerMaxReplicas')]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('{0}-registry-access', deployment().name))]"
              ]
            },
            {
              "condition": "[parameters('authEnabled')]",
              "type": "Microsoft.App/containerApps/authConfigs",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), 'current')]",
              "properties": {
                "platform": {
                  "enabled": true
                },
                "globalValidation": {
                  "unauthenticatedClientAction": "Return401"
                },
                "login": {
                  "tokenStore": {
                    "enabled": false
                  },
                  "allowedExternalRedirectUrls": []
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('authAppId')]",
                      "openIdIssuer": "[parameters('authIssuerUrl')]"
                    },
                    "validation": {
                      "allowedAudiences": "[parameters('authAllowedAudiences')]",
                      "defaultAuthorizationPolicy": {
                        "allowedApplications": "[if(parameters('authRequireClientApp'), createArray(), createArray(parameters('authAppId')))]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-registry-access', deployment().name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "containerRegistryName": {
                    "value": "[parameters('containerRegistryName')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "8594153663897207164"
                    }
                  },
                  "parameters": {
                    "containerRegistryName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "acrPullRole": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                      "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), variables('acrPullRole'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('acrPullRole')]",
                        "principalType": "ServicePrincipal",
                        "principalId": "[parameters('principalId')]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "defaultDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2024-03-01').defaultDomain]"
            },
            "imageName": {
              "type": "string",
              "value": "[parameters('imageName')]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "backend-container-app",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}backend-{1}', variables('abbrs').appContainerApps, variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'backend'))]"
          },
          "containerAppsEnvironmentName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.name.value]"
          },
          "containerRegistryName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.registry.name]"
          },
          "identityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.name.value]"
          },
          "containerName": {
            "value": "backend"
          },
          "imageName": {
            "value": "[parameters('backendImageName')]"
          },
          "targetPort": "[if(not(empty(parameters('backendImageName'))), createObject('value', 8000), createObject('value', 80))]",
          "external": {
            "value": false
          },
          "ingressEnabled": {
            "value": true
          },
          "containerCpuCoreCount": {
            "value": "1.0"
          },
          "containerMemory": {
            "value": "2.0Gi"
          },
          "containerMinReplicas": {
            "value": 1
          },
          "containerMaxReplicas": {
            "value": 5
          },
          "env": {
            "value": [
              {
                "name": "AZURE_AI_PROJECT_ENDPOINT",
                "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.AZURE_AI_PROJECT_ENDPOINT.value]"
              },
              {
                "name": "AZURE_OPENAI_ENDPOINT",
                "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.AZURE_OPENAI_ENDPOINT.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
              },
              {
                "name": "MCP_SERVER_URL",
                "value": "[format('https://{0}mcp-server-{1}.{2}', variables('abbrs').appContainerApps, variables('resourceToken'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.defaultDomain.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.clientId.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17653866244688030665"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "containerAppsEnvironmentName": {
              "type": "string"
            },
            "containerName": {
              "type": "string",
              "defaultValue": "main"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "containerMinReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "metadata": {
                "description": "Minimum number of replicas to run"
              }
            },
            "containerMaxReplicas": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "metadata": {
                "description": "Maximum number of replicas to run"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": []
            },
            "env": {
              "type": "array",
              "defaultValue": []
            },
            "external": {
              "type": "bool",
              "defaultValue": true
            },
            "imageName": {
              "type": "string"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "User assigned identity name"
              }
            },
            "ingressEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled Ingress for container app"
              }
            },
            "daprEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Dapr"
              }
            },
            "daprAppId": {
              "type": "string",
              "defaultValue": "[parameters('containerName')]",
              "metadata": {
                "description": "Dapr app ID"
              }
            },
            "daprAppProtocol": {
              "type": "string",
              "defaultValue": "http",
              "allowedValues": [
                "http",
                "grpc"
              ],
              "metadata": {
                "description": "Protocol used by Dapr to connect to the app, e.g. http or grpc"
              }
            },
            "containerCpuCoreCount": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU cores allocated to a single container instance, e.g. 0.5"
              }
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "1.0Gi",
              "metadata": {
                "description": "Memory allocated to a single container instance, e.g. 1Gi"
              }
            },
            "authEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable authentication"
              }
            },
            "authAppId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication App ID (client ID)"
              }
            },
            "authIssuerUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication Issuer URL"
              }
            },
            "authAllowedAudiences": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed token audiences"
              }
            },
            "authRequireClientApp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Require client application (true) or allow requests only from this application itself (false)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]",
                "configuration": {
                  "activeRevisionsMode": "multiple",
                  "ingress": "[if(parameters('ingressEnabled'), createObject('external', parameters('external'), 'targetPort', parameters('targetPort'), 'transport', 'auto'), null())]",
                  "dapr": "[if(parameters('daprEnabled'), createObject('enabled', true(), 'appId', parameters('daprAppId'), 'appProtocol', parameters('daprAppProtocol'), 'appPort', if(parameters('ingressEnabled'), parameters('targetPort'), 0)), createObject('enabled', false()))]",
                  "secrets": "[parameters('secrets')]",
                  "registries": [
                    {
                      "server": "[format('{0}.azurecr.io', parameters('containerRegistryName'))]",
                      "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[if(not(empty(parameters('imageName'))), parameters('imageName'), 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest')]",
                      "name": "[parameters('containerName')]",
                      "env": "[parameters('env')]",
                      "resources": {
                        "cpu": "[json(parameters('containerCpuCoreCount'))]",
                        "memory": "[parameters('containerMemory')]"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('containerMinReplicas')]",
                    "maxReplicas": "[parameters('containerMaxReplicas')]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('{0}-registry-access', deployment().name))]"
              ]
            },
            {
              "condition": "[parameters('authEnabled')]",
              "type": "Microsoft.App/containerApps/authConfigs",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), 'current')]",
              "properties": {
                "platform": {
                  "enabled": true
                },
                "globalValidation": {
                  "unauthenticatedClientAction": "Return401"
                },
                "login": {
                  "tokenStore": {
                    "enabled": false
                  },
                  "allowedExternalRedirectUrls": []
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('authAppId')]",
                      "openIdIssuer": "[parameters('authIssuerUrl')]"
                    },
                    "validation": {
                      "allowedAudiences": "[parameters('authAllowedAudiences')]",
                      "defaultAuthorizationPolicy": {
                        "allowedApplications": "[if(parameters('authRequireClientApp'), createArray(), createArray(parameters('authAppId')))]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-registry-access', deployment().name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "containerRegistryName": {
                    "value": "[parameters('containerRegistryName')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "8594153663897207164"
                    }
                  },
                  "parameters": {
                    "containerRegistryName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "acrPullRole": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                      "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), variables('acrPullRole'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('acrPullRole')]",
                        "principalType": "ServicePrincipal",
                        "principalId": "[parameters('principalId')]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "defaultDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2024-03-01').defaultDomain]"
            },
            "imageName": {
              "type": "string",
              "value": "[parameters('imageName')]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-server-container-app",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}mcp-server-{1}', variables('abbrs').appContainerApps, variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'mcp-server'))]"
          },
          "containerAppsEnvironmentName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.name.value]"
          },
          "containerRegistryName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.registry.name]"
          },
          "identityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.name.value]"
          },
          "containerName": {
            "value": "mcp-server"
          },
          "imageName": {
            "value": "[parameters('mcpServerImageName')]"
          },
          "targetPort": "[if(not(empty(parameters('mcpServerImageName'))), createObject('value', 8080), createObject('value', 80))]",
          "external": {
            "value": false
          },
          "ingressEnabled": {
            "value": true
          },
          "containerCpuCoreCount": {
            "value": "0.5"
          },
          "containerMemory": {
            "value": "1.0Gi"
          },
          "containerMinReplicas": {
            "value": 1
          },
          "containerMaxReplicas": {
            "value": 3
          },
          "env": {
            "value": [
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17653866244688030665"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "containerAppsEnvironmentName": {
              "type": "string"
            },
            "containerName": {
              "type": "string",
              "defaultValue": "main"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "containerMinReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "metadata": {
                "description": "Minimum number of replicas to run"
              }
            },
            "containerMaxReplicas": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "metadata": {
                "description": "Maximum number of replicas to run"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": []
            },
            "env": {
              "type": "array",
              "defaultValue": []
            },
            "external": {
              "type": "bool",
              "defaultValue": true
            },
            "imageName": {
              "type": "string"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "User assigned identity name"
              }
            },
            "ingressEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled Ingress for container app"
              }
            },
            "daprEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Dapr"
              }
            },
            "daprAppId": {
              "type": "string",
              "defaultValue": "[parameters('containerName')]",
              "metadata": {
                "description": "Dapr app ID"
              }
            },
            "daprAppProtocol": {
              "type": "string",
              "defaultValue": "http",
              "allowedValues": [
                "http",
                "grpc"
              ],
              "metadata": {
                "description": "Protocol used by Dapr to connect to the app, e.g. http or grpc"
              }
            },
            "containerCpuCoreCount": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU cores allocated to a single container instance, e.g. 0.5"
              }
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "1.0Gi",
              "metadata": {
                "description": "Memory allocated to a single container instance, e.g. 1Gi"
              }
            },
            "authEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable authentication"
              }
            },
            "authAppId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication App ID (client ID)"
              }
            },
            "authIssuerUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Authentication Issuer URL"
              }
            },
            "authAllowedAudiences": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed token audiences"
              }
            },
            "authRequireClientApp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Require client application (true) or allow requests only from this application itself (false)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]",
                "configuration": {
                  "activeRevisionsMode": "multiple",
                  "ingress": "[if(parameters('ingressEnabled'), createObject('external', parameters('external'), 'targetPort', parameters('targetPort'), 'transport', 'auto'), null())]",
                  "dapr": "[if(parameters('daprEnabled'), createObject('enabled', true(), 'appId', parameters('daprAppId'), 'appProtocol', parameters('daprAppProtocol'), 'appPort', if(parameters('ingressEnabled'), parameters('targetPort'), 0)), createObject('enabled', false()))]",
                  "secrets": "[parameters('secrets')]",
                  "registries": [
                    {
                      "server": "[format('{0}.azurecr.io', parameters('containerRegistryName'))]",
                      "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[if(not(empty(parameters('imageName'))), parameters('imageName'), 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest')]",
                      "name": "[parameters('containerName')]",
                      "env": "[parameters('env')]",
                      "resources": {
                        "cpu": "[json(parameters('containerCpuCoreCount'))]",
                        "memory": "[parameters('containerMemory')]"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('containerMinReplicas')]",
                    "maxReplicas": "[parameters('containerMaxReplicas')]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('{0}-registry-access', deployment().name))]"
              ]
            },
            {
              "condition": "[parameters('authEnabled')]",
              "type": "Microsoft.App/containerApps/authConfigs",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), 'current')]",
              "properties": {
                "platform": {
                  "enabled": true
                },
                "globalValidation": {
                  "unauthenticatedClientAction": "Return401"
                },
                "login": {
                  "tokenStore": {
                    "enabled": false
                  },
                  "allowedExternalRedirectUrls": []
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('authAppId')]",
                      "openIdIssuer": "[parameters('authIssuerUrl')]"
                    },
                    "validation": {
                      "allowedAudiences": "[parameters('authAllowedAudiences')]",
                      "defaultAuthorizationPolicy": {
                        "allowedApplications": "[if(parameters('authRequireClientApp'), createArray(), createArray(parameters('authAppId')))]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-registry-access', deployment().name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "containerRegistryName": {
                    "value": "[parameters('containerRegistryName')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "8594153663897207164"
                    }
                  },
                  "parameters": {
                    "containerRegistryName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "acrPullRole": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                      "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), variables('acrPullRole'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('acrPullRole')]",
                        "principalType": "ServicePrincipal",
                        "principalId": "[parameters('principalId')]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "defaultDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2024-03-01').defaultDomain]"
            },
            "imageName": {
              "type": "string",
              "value": "[parameters('imageName')]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps-ai-user-role",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "roleDefinitionId": {
            "value": "a97b65f3-24c7-4388-baec-2e87135dc908"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17765727889735572824"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID to assign the role to"
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "allowedValues": [
                "Device",
                "ForeignGroup",
                "Group",
                "ServicePrincipal",
                "User"
              ],
              "metadata": {
                "description": "The type of principal"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "The role definition ID to assign"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "name": {
              "type": "string",
              "value": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps-ai-developer-role",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "roleDefinitionId": {
            "value": "64702f94-c441-49e6-a78b-ef80e0188fee"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17765727889735572824"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID to assign the role to"
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "allowedValues": [
                "Device",
                "ForeignGroup",
                "Group",
                "ServicePrincipal",
                "User"
              ],
              "metadata": {
                "description": "The type of principal"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "The role definition ID to assign"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "name": {
              "type": "string",
              "value": "[guid(subscription().id, resourceGroup().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "AZURE_RESOURCE_GROUP": {
      "type": "string",
      "value": "[parameters('resourceGroupName')]"
    },
    "AZURE_AI_ACCOUNT_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.accountId.value]"
    },
    "AZURE_AI_PROJECT_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.projectId.value]"
    },
    "AZURE_AI_FOUNDRY_PROJECT_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.projectId.value]"
    },
    "AZURE_AI_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.aiServicesAccountName.value]"
    },
    "AZURE_AI_PROJECT_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.projectName.value]"
    },
    "AZURE_AI_PROJECT_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.AZURE_AI_PROJECT_ENDPOINT.value]"
    },
    "AZURE_OPENAI_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.AZURE_OPENAI_ENDPOINT.value]"
    },
    "APPLICATIONINSIGHTS_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
    },
    "AZURE_AI_PROJECT_ACR_CONNECTION_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.registry.connectionName]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.registry.loginServer]"
    },
    "BING_GROUNDING_CONNECTION_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_grounding.connectionName]"
    },
    "BING_GROUNDING_RESOURCE_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_grounding.name]"
    },
    "BING_GROUNDING_CONNECTION_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_grounding.connectionId]"
    },
    "BING_CUSTOM_GROUNDING_CONNECTION_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_custom_grounding.connectionName]"
    },
    "BING_CUSTOM_GROUNDING_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_custom_grounding.name]"
    },
    "BING_CUSTOM_GROUNDING_CONNECTION_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.bing_custom_grounding.connectionId]"
    },
    "AZURE_AI_SEARCH_CONNECTION_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.search.connectionName]"
    },
    "AZURE_AI_SEARCH_SERVICE_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.search.serviceName]"
    },
    "AZURE_STORAGE_CONNECTION_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.storage.connectionName]"
    },
    "AZURE_STORAGE_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-project'), '2025-04-01').outputs.dependentResources.value.storage.accountName]"
    },
    "AZURE_CONTAINER_APPS_ENVIRONMENT_NAME": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.name.value, '')]"
    },
    "AZURE_CONTAINER_APPS_ENVIRONMENT_DOMAIN": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-environment'), '2025-04-01').outputs.defaultDomain.value, '')]"
    },
    "FRONTEND_CONTAINER_APP_NAME": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'frontend-container-app'), '2025-04-01').outputs.name.value, '')]"
    },
    "FRONTEND_URI": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'frontend-container-app'), '2025-04-01').outputs.uri.value, '')]"
    },
    "BACKEND_CONTAINER_APP_NAME": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'backend-container-app'), '2025-04-01').outputs.name.value, '')]"
    },
    "BACKEND_URI": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'backend-container-app'), '2025-04-01').outputs.uri.value, '')]"
    },
    "MCP_SERVER_CONTAINER_APP_NAME": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'mcp-server-container-app'), '2025-04-01').outputs.name.value, '')]"
    },
    "MCP_SERVER_URI": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'mcp-server-container-app'), '2025-04-01').outputs.uri.value, '')]"
    },
    "AZURE_CONTAINER_APPS_IDENTITY_ID": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.id.value, '')]"
    },
    "AZURE_CONTAINER_APPS_IDENTITY_CLIENT_ID": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'container-apps-identity'), '2025-04-01').outputs.clientId.value, '')]"
    }
  }
}